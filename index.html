<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ğŸ¾ NEKOPON Quiz ğŸ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        :root {
            --primary-orange: #d2691e;
            --primary-coral: #ff7f50;
            --primary-brown: #8b4513;
            --accent-pink: #ff69b4;
            --accent-gold: #ffd700;
            --accent-cyan: #00ced1;
            --bg-cream: #faf8f5;
            --bg-white: #ffffff;
            --text-brown: #8b4513;
            --text-orange: #d2691e;
            --border-light: #f4e4bc;
            --shadow-warm: rgba(139,69,19,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚’éƒ¨åˆ†çš„ã«ç„¡åŠ¹åŒ–ï¼ˆå…¥åŠ›è¦ç´ ã¯é™¤å¤–ï¼‰ */
        body, div, span, h1, h2, h3, h4, h5, h6, p {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* ãƒœã‚¿ãƒ³ã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã¯é¸æŠå¯èƒ½ã« */
        button, input, textarea, select {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: #faf8f5; /* å˜è‰²èƒŒæ™¯ã«å¤‰æ›´ */
            min-height: 100vh;
            touch-action: pan-y pinch-zoom;
            color: var(--text-brown);
            font-weight: 700;
            position: relative;
            overflow-x: hidden;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« - ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
        .game-title {
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            font-size: clamp(1.2rem, 4vw, 2rem); /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
            color: var(--primary-orange);
            text-align: center;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative;
        }

        .game-title:hover {
            transform: scale(1.02); /* æ§ãˆã‚ãªãƒ›ãƒãƒ¼åŠ¹æœ */
        }

        .game-title.title-bounce {
            animation: title-gentle-bounce 0.6s ease-out;
        }

        @keyframes title-gentle-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* çŒ«ã‚¢ã‚¤ã‚³ãƒ³ */
        .cat-icon {
            display: inline-block;
            cursor: pointer;
            font-size: 1em;
            margin: 0 8px;
            transition: transform 0.2s ease-out;
        }

        .cat-icon:hover {
            transform: scale(1.1);
        }

        .cat-icon.bounce {
            animation: cat-gentle-bounce 0.5s ease-out;
        }

        @keyframes cat-gentle-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }

        @media (min-width: 640px) {
            .container-spacing { max-width: 500px; }
        }
        @media (min-width: 768px) {
            .container-spacing { max-width: 600px; }
        }
        @media (min-width: 1024px) {
            .container-spacing { max-width: 700px; }
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .clean-card {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 20px;
            box-shadow: 0 4px 15px var(--shadow-warm);
            position: relative;
            overflow: hidden;
        }

        /* ãƒœã‚¿ãƒ³ */
        .clean-button {
            background: linear-gradient(145deg, var(--primary-orange), var(--primary-coral));
            border: none;
            color: white;
            font-weight: 700;
            border-radius: 15px;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(210,105,30,0.2);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
        }

        .clean-button:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(210,105,30,0.3);
        }

        .clean-button:active {
            transform: scale(0.98);
        }

        /* ç”Ÿãç‰©ã‚‰ã—ã„ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .organic-tap {
            animation: organic-button-tap 0.4s ease-out !important;
        }

        @keyframes organic-button-tap {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(0.95); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* æ•™ç§‘ãƒœã‚¿ãƒ³ */
        .subject-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 15px;
            color: var(--text-brown);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 1.5rem 1rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow-warm);
            cursor: pointer;
            touch-action: manipulation;
        }

        .subject-btn:hover {
            border-color: var(--primary-orange);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(210,105,30,0.2);
        }

        .subject-btn.active {
            background: #fff0e6;
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: scale(1.02);
        }

        /* ç”Ÿãç‰©ã‚‰ã—ã„æ•™ç§‘ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .subject-btn.organic-tap {
            animation: subject-organic-tap 0.5s ease-out !important;
        }

        @keyframes subject-organic-tap {
            0% { transform: scale(1); }
            20% { transform: scale(1.15); }
            40% { transform: scale(0.9); }
            60% { transform: scale(1.1); }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .subject-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            transition: transform 0.2s ease;
        }

        .subject-btn:hover .subject-icon {
            transform: scale(1.1);
        }

        .subject-name {
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        /* ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ */
        .category-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            color: var(--text-brown);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 70px;
            box-shadow: 0 2px 6px var(--shadow-warm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
        }

        .category-btn:hover {
            border-color: var(--primary-orange);
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(210,105,30,0.15);
        }

        .category-btn.active {
            background: #ffe4d1;
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: scale(1.02);
        }

        /* ç”Ÿãç‰©ã‚‰ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .category-btn.organic-tap {
            animation: category-organic-tap 0.3s ease-out !important;
        }

        @keyframes category-organic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* ã‚¯ã‚¤ã‚ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
        .quiz-option {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            color: var(--text-brown);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow-warm);
            cursor: pointer;
            overflow: hidden;
            touch-action: manipulation;
        }

        .quiz-option:hover {
            border-color: var(--primary-orange);
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(210,105,30,0.2);
        }

        .quiz-option span {
            position: relative;
            z-index: 1;
        }

        /* ç”Ÿãç‰©ã‚‰ã—ã„ã‚¯ã‚¤ã‚ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .quiz-option.organic-tap {
            animation: quiz-option-organic-tap 0.3s ease-out !important;
        }

        @keyframes quiz-option-organic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(139,69,19,0.4);
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .modal.show {
            display: flex;
            animation: modal-gentle-enter 0.3s ease-out;
        }

        @keyframes modal-gentle-enter {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œã« */
        .modal .clean-card {
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: auto;
            touch-action: pan-y;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
        .modal .grid {
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-right: 4px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .stats-display {
            background: #fff8f0;
            border: 2px solid var(--border-light);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 3px 10px var(--shadow-warm);
            position: relative;
            overflow: hidden;
        }

        /* ã‚¹ã‚³ã‚¢é …ç›® */
        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-brown);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
        }

        .score-value:hover {
            color: var(--primary-orange);
            transform: scale(1.05);
        }

        /* ãƒ¬ãƒ™ãƒ«ãƒ»ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ  - ãƒ©ã‚¤ãƒˆåŠ¹æœå‰Šé™¤ */
        .level-badge {
            display: inline-block;
            background: linear-gradient(145deg, var(--accent-gold), #ffb347);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-weight: 700;
            margin: 0.25rem;
            box-shadow: 0 2px 6px rgba(255,215,0,0.2);
            cursor: pointer;
            touch-action: manipulation;
            transition: transform 0.2s ease;
        }

        .level-badge:hover {
            transform: scale(1.05);
        }

        .level-badge.organic-tap {
            animation: badge-organic-tap 0.3s ease-out !important;
        }

        @keyframes badge-organic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            font-size: 1.2rem;
            animation: particle-gentle 1.5s ease-out forwards;
        }

        @keyframes particle-gentle {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) scale(1.2);
                opacity: 0;
            }
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-white);
            color: var(--text-brown);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border: 2px solid var(--border-light);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 15px var(--shadow-warm);
        }

        .notification.show {
            transform: translateX(0);
        }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        .floating-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, var(--primary-orange), var(--primary-coral));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(210,105,30,0.3);
            transition: all 0.2s ease;
            z-index: 1002;
            cursor: pointer;
            touch-action: manipulation;
        }

        .floating-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(210,105,30,0.4);
        }

        .floating-button.hidden {
            display: none !important;
        }

        .floating-button.organic-tap {
            animation: floating-organic-tap 0.4s ease-out !important;
        }

        @keyframes floating-organic-tap {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(0.9); }
            75% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ */
        .mode-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 10px;
            color: var(--text-brown);
            transition: all 0.2s ease;
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px var(--shadow-warm);
            cursor: pointer;
            touch-action: manipulation;
        }

        .mode-btn:hover {
            border-color: var(--primary-orange);
            transform: scale(1.02);
        }

        .mode-btn.active {
            background: #ffe4d1;
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: scale(1.02);
        }

        .mode-btn.organic-tap {
            animation: mode-organic-tap 0.2s ease-out !important;
        }

        @keyframes mode-organic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 640px) {
            .game-title { font-size: clamp(1rem, 5vw, 1.5rem); }
            .cat-icon { font-size: 0.9em; margin: 0 6px; }
            .subject-btn { padding: 1rem 0.75rem; min-height: 80px; }
            .category-btn { padding: 0.75rem 0.5rem; min-height: 60px; font-size: 0.8rem; }
            .quiz-option { padding: 0.75rem 1rem; font-size: 0.9rem; }
            .floating-button { width: 50px; height: 50px; font-size: 1.2rem; bottom: 25px; left: 25px; }
        }

        /* ã‚¯ã‚¤ã‚ºèª¬æ˜ã‚¨ãƒªã‚¢ */
        .quiz-explanation {
            min-height: 100px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
            transition: all 0.2s ease;
        }

        .quiz-explanation.has-content {
            border-color: var(--primary-coral);
            background: #fff0e6;
        }

        .back-button {
            background: #f1f5f9;
            border: 2px solid var(--border-light);
            color: var(--text-brown);
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 6px var(--shadow-warm);
            touch-action: manipulation;
        }

        .back-button:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }

        .back-button.organic-tap {
            animation: back-organic-tap 0.2s ease-out !important;
        }

        @keyframes back-organic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† -->
    <div class="text-center mb-4">
        <h1 class="game-title" id="mainTitle">
            <span class="cat-icon" id="leftCat">ğŸ±</span>
            NEKOPON Quiz
            <span class="cat-icon" id="rightCat">ğŸ±</span>
        </h1>
        <div id="levelBadges" class="mt-2"></div>
    </div>

    <!-- æ•™ç§‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mainSubjectModal" class="modal show">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    ğŸ“š æ•™ç§‘ã‚’é¸æŠã—ã¦ã«ã‚ƒã€œ
                </h2>
                <p class="text-orange-600 text-sm">ã©ã®æ•™ç§‘ã§éŠã¶ã‹é¸ã‚“ã§ãã ã•ã„â™ª</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-subject="social">
                    <div class="subject-icon">ğŸŒ</div>
                    <div class="subject-name">ç¤¾ä¼š</div>
                </button>
                <button class="subject-btn" data-subject="science">
                    <div class="subject-icon">ğŸ”¬</div>
                    <div class="subject-name">ç†ç§‘</div>
                </button>
                <button class="subject-btn" data-subject="english">
                    <div class="subject-icon">ğŸ“–</div>
                    <div class="subject-name">è‹±èª</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ç¤¾ä¼šåˆ†é‡é¸æŠ -->
    <div id="socialModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    ğŸŒ ç¤¾ä¼šã®åˆ†é‡ã‚’é¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">ã©ã®åˆ†é‡ã§å­¦ç¿’ã™ã‚‹ã‹é¸ã‚“ã§ãã ã•ã„â™ª</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-category="geography">
                    <div class="subject-icon">ğŸ—ºï¸</div>
                    <div class="subject-name">åœ°ç†</div>
                </button>
                <button class="subject-btn" data-category="history">
                    <div class="subject-icon">ğŸ›ï¸</div>
                    <div class="subject-name">æ­´å²</div>
                </button>
                <button class="subject-btn" data-category="civics">
                    <div class="subject-icon">âš–ï¸</div>
                    <div class="subject-name">å…¬æ°‘</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ç†ç§‘åˆ†é‡é¸æŠ -->
    <div id="scienceModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    ğŸ”¬ ç†ç§‘ã®åˆ†é‡ã‚’é¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">ã©ã®åˆ†é‡ã§å­¦ç¿’ã™ã‚‹ã‹é¸ã‚“ã§ãã ã•ã„â™ª</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button class="subject-btn" data-category="chemistry">
                    <div class="subject-icon">ğŸ§ª</div>
                    <div class="subject-name">åŒ–å­¦</div>
                </button>
                <button class="subject-btn" data-category="biology">
                    <div class="subject-icon">ğŸ§¬</div>
                    <div class="subject-name">ç”Ÿç‰©</div>
                </button>
                <button class="subject-btn" data-category="physics">
                    <div class="subject-icon">âš›ï¸</div>
                    <div class="subject-name">ç‰©ç†</div>
                </button>
                <button class="subject-btn" data-category="earth">
                    <div class="subject-icon">ğŸŒ</div>
                    <div class="subject-name">åœ°å­¦</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±èªåˆ†é‡é¸æŠ -->
    <div id="englishModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    ğŸ“– è‹±èªã®åˆ†é‡ã‚’é¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">ã©ã®åˆ†é‡ã§å­¦ç¿’ã™ã‚‹ã‹é¸ã‚“ã§ãã ã•ã„â™ª</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-category="english_words">
                    <div class="subject-icon">ğŸ“</div>
                    <div class="subject-name">è‹±å˜èª</div>
                </button>
                <button class="subject-btn" data-category="english_phrases">
                    <div class="subject-icon">ğŸ’¬</div>
                    <div class="subject-name">è‹±ç†Ÿèª</div>
                </button>
                <button class="subject-btn" data-category="english_grammar">
                    <div class="subject-icon">ğŸ“˜</div>
                    <div class="subject-name">èªå½¢å¤‰åŒ–</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåœ°ç†ï¼‰ -->
    <div id="geographyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ—ºï¸ åœ°ç†ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="geographyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startGeographyQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚åŒæ§˜ã«... -->
    <!-- æ­´å² -->
    <div id="historyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ›ï¸ æ­´å²ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="historyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startHistoryQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- å…¬æ°‘ -->
    <div id="civicsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    âš–ï¸ å…¬æ°‘ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="civicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startCivicsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- åŒ–å­¦ -->
    <div id="chemistryModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ§ª åŒ–å­¦ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="chemistryCategories"></div>
            <div class="text-center space-y-2">
                <button id="startChemistryQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ç”Ÿç‰© -->
    <div id="biologyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ§¬ ç”Ÿç‰©ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="biologyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startBiologyQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ç‰©ç† -->
    <div id="physicsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    âš›ï¸ ç‰©ç†ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="physicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startPhysicsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- åœ°å­¦ -->
    <div id="earthModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸŒ åœ°å­¦ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="earthCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEarthQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±å˜èª -->
    <div id="englishWordsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ“ è‹±å˜èªã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishWordsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishWordsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±ç†Ÿèª -->
    <div id="englishPhrasesModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ’¬ è‹±ç†Ÿèªã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishPhrasesCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishPhrasesQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- èªå½¢å¤‰åŒ– -->
    <div id="englishGrammarModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ğŸ“˜ èªå½¢å¤‰åŒ–ã®å˜å…ƒé¸æŠ
                </h2>
                <p class="text-orange-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishGrammarCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishGrammarQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    ğŸ¯ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden">
        <div class="clean-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title">ğŸ¾ NEKOPON Quiz ğŸ¾</h1>
            <div id="currentCategory" class="text-lg font-bold text-orange-700 mb-4"></div>
            
            <div class="stats-display">
                <div class="grid grid-cols-4 gap-4 text-center mb-4">
                    <div>
                        <div class="score-value" id="correctCount">0</div>
                        <div class="text-xs text-orange-600">æ­£è§£æ•°</div>
                    </div>
                    <div>
                        <div class="score-value" id="wrongCount">0</div>
                        <div class="text-xs text-orange-600">ä¸æ­£è§£æ•°</div>
                    </div>
                    <div>
                        <div class="score-value" id="totalCount">0</div>
                        <div class="text-xs text-orange-600">ç·å•é¡Œæ•°</div>
                    </div>
                    <div>
                        <div class="score-value" id="comboCount">0</div>
                        <div class="text-xs text-orange-600">é€£ç¶šæ­£è§£</div>
                    </div>
                </div>
                
                <div class="h-px bg-orange-200 my-4"></div>
                
                <div class="text-center">
                    <div class="text-sm font-bold text-orange-700 mb-3">ğŸ“‹ å‡ºé¡Œå½¢å¼</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                            ğŸ² ãƒ©ãƒ³ãƒ€ãƒ 
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                            ğŸ“‹ é †ç•ªé€šã‚Š
                        </button>
                    </div>
                    <div class="text-xs text-orange-600 mt-2" id="modeDescription">
                        å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™
                    </div>
                </div>
            </div>
            
            <button id="startQuizButton" class="clean-button px-8 py-4 text-lg font-bold mt-6">
                âœ¨ ã‚¯ã‚¤ã‚ºé–‹å§‹ã«ã‚ƒã€œï¼ âœ¨
            </button>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="quizModal" class="modal">
        <div class="clean-card p-6 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-bold text-xl text-orange-700">
                    ğŸ¾ NEKOPON Quiz ğŸ¾
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-lg font-bold text-center text-orange-800 leading-relaxed"></p>
                <div id="quizOptions" class="space-y-3"></div>
                <div id="quizExplanation" class="quiz-explanation">
                    <p id="quizMsg" class="font-bold text-center text-lg"></p>
                </div>
                <div class="flex gap-3">
                    <button id="quizNext" class="flex-1 clean-button py-3 text-sm">
                        ğŸŒŸ æ¬¡ã®å•é¡Œã«ã‚ƒã€œ
                    </button>
                    <button id="quizBack" class="flex-1 back-button py-3 text-sm">
                        ğŸ  æˆ»ã‚‹ã«ã‚ƒã€œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <button id="changeSubject" class="floating-button hidden">
        ğŸ“š
    </button>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ±</span>
            <div>
                <div class="font-bold text-sm">NEKOPON Quiz</div>
                <div id="notificationText" class="text-xs text-orange-600"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- NEKOPONé¢¨ åŠ¹æœéŸ³ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè»½é‡ç‰ˆï¼‰ ----------------- */
        class NekoponSoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            // åŸºæœ¬éŸ³ã®ç”Ÿæˆï¼ˆè»½é‡ç‰ˆï¼‰
            createTone(frequency, duration, volume = 0.2, type = 'sine') {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒªãƒƒã‚¯éŸ³
            playClick() {
                this.createTone(600, 0.1, 0.1, 'sine');
            }

            // æ­£è§£éŸ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
            playCorrect() {
                this.createTone(800, 0.2, 0.15);
                setTimeout(() => this.createTone(1000, 0.2, 0.1), 100);
            }

            // ä¸æ­£è§£éŸ³ï¼ˆå„ªã—ãï¼‰
            playWrong() {
                this.createTone(300, 0.2, 0.1, 'triangle');
            }

            // ãã®ä»–ã®éŸ³ã‚‚åŒæ§˜ã«ã‚·ãƒ³ãƒ—ãƒ«åŒ–
            playSubjectTap() {
                this.createTone(700, 0.15, 0.12);
            }

            playCategoryTap() {
                this.createTone(500, 0.1, 0.1);
            }

            playTitleBounce() {
                this.createTone(800, 0.3, 0.15);
            }

            playCatBounce() {
                this.createTone(700, 0.2, 0.1);
            }
        }

        const nekoponSound = new NekoponSoundSystem();

        /* ----------------- éŸ³å£°ç™ºéŸ³ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ----------------- */
        function speakWord(wordToSpeak) {
            if (!('speechSynthesis' in window) || !wordToSpeak) return;
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                const voices = speechSynthesis.getVoices();
                let preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang) && (v.name.includes('Google') || v.localService || v.default));
                if (!preferredVoice) preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang));
               
                utterance.voice = preferredVoice || voices.find(v => v.lang && v.lang.startsWith('en-')); 
                utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
                utterance.rate = 0.9; 
                utterance.pitch = 1;
                speechSynthesis.cancel(); 
                speechSynthesis.speak(utterance);
            }, 100);
        }

        function isEnglishCategory() {
            return selectedCategories.some(categoryId => 
                categoryId.startsWith('words_') || categoryId.startsWith('phrases_') || categoryId.startsWith('grammar_')
            );
        }

        /* ----------------- ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç°¡ç´ ç‰ˆï¼‰ ----------------- */
        class NekoponGameification {
            constructor() {
                this.playerLevel = 1;
                this.totalExperience = 0;
                this.achievements = new Set();
                this.comboCount = 0;
                this.maxCombo = 0;
            }

            // æ­£è§£æ™‚ã®å‡¦ç†
            onCorrectAnswer() {
                this.comboCount++;
                this.maxCombo = Math.max(this.maxCombo, this.comboCount);
                this.totalExperience += 10;

                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®š
                const newLevel = Math.floor(this.totalExperience / 100) + 1;
                if (newLevel > this.playerLevel) {
                    this.playerLevel = newLevel;
                    this.updateLevelBadges();
                }

                this.updateDisplay();
            }

            // ä¸æ­£è§£æ™‚ã®å‡¦ç†
            onWrongAnswer() {
                this.comboCount = 0;
                this.updateDisplay();
            }

            // ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸æ›´æ–°
            updateLevelBadges() {
                const container = document.getElementById('levelBadges');
                container.innerHTML = '';
                
                for (let i = 1; i <= this.playerLevel; i++) {
                    const badge = document.createElement('span');
                    badge.className = 'level-badge';
                    badge.textContent = `Lv.${i}`;
                    badge.onclick = () => {
                        nekoponSound.playClick();
                        badge.classList.add('organic-tap');
                        setTimeout(() => badge.classList.remove('organic-tap'), 300);
                        createParticle('ğŸ†', '#FFD700', badge.getBoundingClientRect().left + 20, badge.getBoundingClientRect().top);
                    };
                    container.appendChild(badge);
                }
            }

            // è¡¨ç¤ºæ›´æ–°
            updateDisplay() {
                document.getElementById('comboCount').textContent = this.comboCount;
            }

            // ãƒªã‚»ãƒƒãƒˆ
            reset() {
                this.comboCount = 0;
                this.updateDisplay();
            }
        }

        const gameification = new NekoponGameification();

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾© ----------------- */
        const categories = {
            geography: [
                {id: 'geo_world_overview', name: '1.ä¸–ç•Œã®å§¿'},
                {id: 'geo_japan_overview', name: '2.æ—¥æœ¬ã®å§¿'},
                {id: 'geo_world_life', name: '3.ä¸–ç•Œå„åœ°ã®äººã€…ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},
                {id: 'geo_asia', name: '4.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ã‚¸ã‚¢å·'},
                {id: 'geo_europe', name: '5.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},
                {id: 'geo_africa', name: '6.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ãƒ•ãƒªã‚«å·'},
                {id: 'geo_north_america', name: '7.ä¸–ç•Œã®è«¸åœ°åŸŸã€€åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_south_america', name: '8.ä¸–ç•Œã®è«¸åœ°åŸŸã€€å—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_oceania', name: '9.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},
                {id: 'geo_japan_features', name: '10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},
                {id: 'geo_japan_kyushu', name: '11.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¹å·åœ°æ–¹'},
                {id: 'geo_japan_chugoku', name: '12.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},
                {id: 'geo_japan_kinki', name: '13.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€è¿‘ç•¿åœ°æ–¹'},
                {id: 'geo_japan_chubu', name: '14.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­éƒ¨åœ°æ–¹'},
                {id: 'geo_japan_kanto', name: '15.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€é–¢æ±åœ°æ–¹'},
                {id: 'geo_japan_tohoku', name: '16.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€æ±åŒ—åœ°æ–¹'},
                {id: 'geo_japan_hokkaido', name: '17.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€åŒ—æµ·é“åœ°æ–¹'}
            ],
            history: [
                {id: 'hist_ancient', name: '1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬ã®æˆã‚Šç«‹ã¡'},
                {id: 'hist_ancient_state', name: '2.å¤ä»£å›½å®¶ã®æ­©ã¿ã¨æ±ã‚¢ã‚¸ã‚¢'},
                {id: 'hist_kamakura', name: '3.æ­¦å£«ã®ãŠã“ã‚Šã¨éŒå€‰å¹•åºœ'},
                {id: 'hist_muromachi', name: '4.ãƒ¢ãƒ³ã‚´ãƒ«ã®è¥²æ¥ã¨å®¤ç”ºå¹•åºœ'},
                {id: 'hist_unification', name: '5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘äººã¨ã®å‡ºä¼šã„ã¨å…¨å›½çµ±ä¸€'},
                {id: 'hist_edo_early', name: '6.æ±Ÿæˆ¸å¹•åºœã®æˆç«‹ã¨é–å›½'},
                {id: 'hist_edo_develop', name: '7.ç”£æ¥­ã®ç™ºé”ã¨å¹•åºœæ”¿æ²»ã®å±•é–‹'},
                {id: 'hist_opening', name: '8.æ¬§ç±³ã®é€²å‡ºã¨æ—¥æœ¬ã®é–‹å›½'},
                {id: 'hist_meiji', name: '9.æ˜æ²»ç¶­æ–°'},
                {id: 'hist_wars', name: '10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰ã¨æ—¥æœ¬ã®ç”£æ¥­é©å‘½'},
                {id: 'hist_wwi', name: '11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦ã¨æ—¥æœ¬'},
                {id: 'hist_wwii', name: '12.ä¸–ç•Œææ…Œã¨ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},
                {id: 'hist_postwar', name: '13.æˆ¦å¾Œã®æ—¥æœ¬ã®ç™ºå±•ã¨å›½éš›ç¤¾ä¼š'}
            ],
            civics: [
                {id: 'civics_modern', name: '1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},
                {id: 'civics_constitution', name: '2.äººé–“ã®å°Šé‡ã¨æ—¥æœ¬å›½æ†²æ³•'},
                {id: 'civics_democracy', name: '3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},
                {id: 'civics_economy', name: '4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'}
            ],
            chemistry: [
                {id: 'chemistry_basic', name: '1.ç‰©è³ªã¨ãã®æ€§è³ª'},
                {id: 'chemistry_gas', name: '2.æ°—ä½“ã®æ€§è³ª'},
                {id: 'chemistry_solution', name: '3.æ°´æº¶æ¶²ã®æ€§è³ª'},
                {id: 'chemistry_state', name: '4.çŠ¶æ…‹å¤‰åŒ–'},
                {id: 'chemistry_change', name: '5.ç‰©è³ªã®å¤‰åŒ–'},
                {id: 'chemistry_structure', name: '6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},
                {id: 'chemistry_reaction', name: '7.ç‰©è³ªã©ã†ã—ã®åŒ–å­¦å¤‰åŒ–'},
                {id: 'chemistry_mass', name: '8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},
                {id: 'chemistry_ion', name: '9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},
                {id: 'chemistry_acid', name: '10.é…¸ã€ã‚¢ãƒ«ã‚«ãƒªã€å¡©'}
            ],
            biology: [
                {id: 'biology_flower', name: '1.èŠ±ã®ã¤ãã‚Š'},
                {id: 'biology_plant', name: '2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Šã€æ¤ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_animal', name: '3.å‹•ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_microscope', name: '4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},
                {id: 'biology_cell', name: '5.ç”Ÿç‰©ã¨ç´°èƒ'},
                {id: 'biology_plant_body', name: '6.æ¤ç‰©ã®ã‹ã‚‰ã ã®ã¤ãã‚Šã€æ¤ç‰©ã¨æ—¥å…‰'},
                {id: 'biology_digestion', name: '7.æ¶ˆåŒ–ã¨å¸å'},
                {id: 'biology_breathing', name: '8.å‘¼å¸'},
                {id: 'biology_circulation', name: '9.è¡€æ¶²ã®å¾ªç’°ã€æ’å‡ºã®ã—ãã¿'},
                {id: 'biology_response', name: '10.åˆºæ¿€ã¨åå¿œã€å‹•ç‰©ã®ã‹ã‚‰ã '},
                {id: 'biology_growth', name: '11.ç”Ÿç‰©ã®æˆé•·ã¨ç´°èƒã®å¤‰åŒ–'},
                {id: 'biology_reproduction', name: '12.ç”Ÿç‰©ã®ç”Ÿæ®–'},
                {id: 'biology_heredity', name: '13.éºä¼ã®è¦å‰‡æ€§ã¨éºä¼å­'},
                {id: 'biology_evolution', name: '14.ç”Ÿç‰©ã®é€²åŒ–ã€ç”Ÿæ…‹ç³»ã¨é£Ÿç‰©é€£é–'},
                {id: 'biology_environment', name: '15.è‡ªç„¶ã¨ç’°å¢ƒã€äººé–“ã¨è‡ªç„¶ç’°å¢ƒ'}
            ],
            physics: [
                {id: 'physics_light', name: '1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_sound', name: '2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_force', name: '3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_current', name: '4.é›»æµã¨é›»åœ§'},
                {id: 'physics_energy', name: '5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
                {id: 'physics_magnetic', name: '6.é›»æµã¨ç£ç•Œ'},
                {id: 'physics_balance', name: '7.åŠ›ã®ã¤ã‚Šåˆã„ã¨åˆæˆãƒ»åˆ†è§£'},
                {id: 'physics_motion', name: '8.ç‰©ä½“ã®é‹å‹•'},
                {id: 'physics_pressure', name: '9.æ°´åœ§ã¨æµ®åŠ›'},
                {id: 'physics_work', name: '10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},
                {id: 'physics_energy_change', name: '11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},
                {id: 'physics_resources', name: '12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æºã®åˆ©ç”¨'}
            ],
            earth: [
                {id: 'earth_volcano', name: '1.ç«å±±'},
                {id: 'earth_earthquake', name: '2.åœ°éœ‡'},
                {id: 'earth_strata', name: '3.åœ°å±¤ã®ã§ãæ–¹'},
                {id: 'earth_weather', name: '4.æ°—è±¡ã®è¦³æ¸¬ã€å¤§æ°—åœ§ã¨åœ§åŠ›'},
                {id: 'earth_front', name: '5.æ°—å›£ã¨å‰ç·šã€æ—¥æœ¬ã®å¤©æ°—'},
                {id: 'earth_cloud', name: '6.é›²ã®ã§ãæ–¹ã¨æ°´è’¸æ°—'},
                {id: 'earth_celestial', name: '7.åœ°çƒã®å‹•ãã¨å¤©ä½“ã®å‹•ã'},
                {id: 'earth_solar', name: '8.å¤ªé™½ç³»ã®å¤©ä½“'},
                {id: 'earth_moon', name: '9.æœˆã¨æƒ‘æ˜Ÿã®è¦‹ãˆæ–¹ã€è‡ªç„¶ã®æµã¿ã¨ç½å®³'}
            ],
            english_words: [
                {id: 'words_time', name: 'æœˆãƒ»åºæ•°'},
                {id: 'words_week', name: 'æ›œæ—¥'},
                {id: 'words_timeday', name: 'æ™‚ãƒ»æ™‚é–“å¸¯ãªã©'},
                {id: 'words_season', name: 'å­£ç¯€ãƒ»å®¶æ—'},
                {id: 'words_sports', name: 'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},
                {id: 'words_job', name: 'è·æ¥­ãƒ»äººãƒ»å»ºç‰©ãƒ»æ–½è¨­'},
                {id: 'words_uncountable', name: 'æ•°ãˆã‚‰ã‚Œãªã„åè©'},
                {id: 'words_verb_important', name: 'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},
                {id: 'words_verb_various', name: 'ã„ã‚ã„ã‚ãªæ„å‘³ã‚’ã‚‚ã¤å‹•è©'},
                {id: 'words_verb_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„å‹•è©'},
                {id: 'words_verb_other', name: 'ãã®ä»–ã®é‡è¦å‹•è©'},
                {id: 'words_adj_quantity', name: 'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},
                {id: 'words_adj_various', name: 'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},
                {id: 'words_adj_adv', name: 'ãã®ä»–ã®é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},
                {id: 'words_adv_manner', name: 'æ§˜å­ã‚’è¡¨ã™å‰¯è©'}
            ],
            english_phrases: [
                {id: 'phrases_verb', name: 'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„ç†Ÿèª'},
                {id: 'phrases_similar', name: 'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},
                {id: 'phrases_verb_other', name: 'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_be', name: 'be å‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},
                {id: 'phrases_quantity', name: 'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_time_place', name: 'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_important', name: 'ãã®ä»–ã®é‡è¦ç†Ÿèª'}
            ],
            english_grammar: [
                {id: 'grammar_irregular_past', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_irregular_same', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ã¨éå»åˆ†è©ãŒåŒã˜'},
                {id: 'grammar_irregular_special', name: 'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹'},
                {id: 'grammar_be_past', name: 'be å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_regular', name: 'è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_third_person', name: 'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},
                {id: 'grammar_ing', name: 'å‹•è©ã® -ing å½¢'},
                {id: 'grammar_comparative', name: 'å½¢å®¹è© - æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},
                {id: 'grammar_more_most', name: 'moreã€most ã‚’ã¤ã‘ã‚‹å½¢å®¹è©'},
                {id: 'grammar_noun_plural', name: 'åè©ã®è¤‡æ•°å½¢'},
                {id: 'grammar_irregular_plural', name: 'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},
                {id: 'grammar_pronoun', name: 'äººç§°ä»£åè©'}
            ]
        };

        /* ----------------- ã‚²ãƒ¼ãƒ å¤‰æ•° ----------------- */
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalCount = 0;
        let usedQuestions = [];
        let particleOffset = 0;
        let currentSubject = '';
        let questionMode = 'random';
        let sequentialIndex = 0;

        /* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ï¼ˆç°¡ç´ ç‰ˆï¼‰ ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            document.body.appendChild(particle);

            particleOffset += 20;
            if (particleOffset > 80) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 1500);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /* ----------------- ç”»é¢é·ç§»é–¢æ•° ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainSubjectModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToSocial() {
            hideAllModals();
            document.getElementById('socialModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToScience() {
            hideAllModals();
            document.getElementById('scienceModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToEnglish() {
            hideAllModals();
            document.getElementById('englishModal').classList.add('show');
            nekoponSound.playClick();
        }

        /* ----------------- ç”Ÿãç‰©ã‚‰ã—ã„ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ é–¢æ•° ----------------- */
        function addOrganicTapEffect(element, soundType = 'click') {
            // é‡è¤‡ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’é˜²ã
            if (element.hasOrganicEffect) return;
            element.hasOrganicEffect = true;

            element.addEventListener('click', function(e) {
                // éŸ³ã®ç¨®é¡ã«å¿œã˜ã¦é©åˆ‡ãªéŸ³ã‚’å†ç”Ÿ
                switch(soundType) {
                    case 'subject':
                        nekoponSound.playSubjectTap();
                        break;
                    case 'category':
                        nekoponSound.playCategoryTap();
                        break;
                    default:
                        nekoponSound.playClick();
                }
                
                // ç”Ÿãç‰©ã‚‰ã—ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                this.classList.add('organic-tap');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒ©ã‚¹å‰Šé™¤
                setTimeout(() => {
                    this.classList.remove('organic-tap');
                }, soundType === 'subject' ? 500 : (soundType === 'category' ? 300 : 200));
            });
        }

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã®åˆæœŸåŒ– ----------------- */
        function initCategorySelection() {
            // åœ°ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const geographyContainer = document.getElementById('geographyCategories');
            categories.geography.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('geography', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                geographyContainer.appendChild(btn);
            });

            // æ­´å²ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const historyContainer = document.getElementById('historyCategories');
            categories.history.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('history', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                historyContainer.appendChild(btn);
            });

            // å…¬æ°‘ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const civicsContainer = document.getElementById('civicsCategories');
            categories.civics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('civics', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                civicsContainer.appendChild(btn);
            });

            // åŒ–å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const chemistryContainer = document.getElementById('chemistryCategories');
            categories.chemistry.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                chemistryContainer.appendChild(btn);
            });

            // ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const biologyContainer = document.getElementById('biologyCategories');
            categories.biology.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                biologyContainer.appendChild(btn);
            });

            // ç‰©ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const physicsContainer = document.getElementById('physicsCategories');
            categories.physics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                physicsContainer.appendChild(btn);
            });

            // åœ°å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const earthContainer = document.getElementById('earthCategories');
            categories.earth.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                earthContainer.appendChild(btn);
            });

            // è‹±å˜èªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishWordsContainer = document.getElementById('englishWordsCategories');
            categories.english_words.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_words', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                englishWordsContainer.appendChild(btn);
            });

            // è‹±ç†Ÿèªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishPhrasesContainer = document.getElementById('englishPhrasesCategories');
            categories.english_phrases.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_phrases', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                englishPhrasesContainer.appendChild(btn);
            });

            // èªå½¢å¤‰åŒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishGrammarContainer = document.getElementById('englishGrammarCategories');
            categories.english_grammar.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_grammar', category.id, btn);
                addOrganicTapEffect(btn, 'category');
                englishGrammarContainer.appendChild(btn);
            });
        }

        function toggleCategorySelection(subject, categoryId, buttonElement) {
            if (selectedCategories.includes(categoryId)) {
                selectedCategories = selectedCategories.filter(id => id !== categoryId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(categoryId);
                buttonElement.classList.add('active');
            }

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const camelCase = subject.split('_')
                .map((word, index) => index === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
            const startButton = document.getElementById(`start${camelCase}Quiz`);

            if (startButton) {
                startButton.disabled = selectedCategories.length === 0;
            }
        }

        function startSelectedQuiz(subject, subjectName) {
            currentSubject = subject;
            hideAllModals();
            document.getElementById('currentCategory').textContent = `${subjectName} - ${selectedCategories.length}å˜å…ƒé¸æŠ`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
            correctCount = 0;
            wrongCount = 0;
            totalCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            gameification.reset();
            updateStats();
            showNotification(`${subjectName}ã®${selectedCategories.length}å˜å…ƒã‚’é¸æŠã—ã¾ã—ãŸ`);
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™';
                usedQuestions = [];
                showNotification('ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã—ã¾ã™';
                sequentialIndex = 0;
                showNotification('é †ç•ªé€šã‚Šå‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
            }
        }

        /* ----------------- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) {
                showNotification('é¸æŠã•ã‚ŒãŸå˜å…ƒã®å•é¡Œã¯ã¾ã æº–å‚™ä¸­ã§ã™');
                return;
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('å…¨å•ã‚¯ãƒªã‚¢ï¼å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('å…¨å•é¡Œã‚’ä¸€å‘¨ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<span>${txt}</span>`;
                btn.className = 'quiz-option w-full';
                
                // ç”Ÿãç‰©ã‚‰ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                addOrganicTapEffect(btn);
                
                btn.onclick = () => {
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        
                        if (i === quiz.ans) {
                            correctCount++;
                            gameification.onCorrectAnswer();
                            nekoponSound.playCorrect();
                            showNotification('æ­£è§£ã§ã™ï¼');
                            createParticle('âœ“', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
                            
                            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                            if ('vibrate' in navigator) {
                                navigator.vibrate([50, 25, 50]);
                            }
                        } else {
                            wrongCount++;
                            gameification.onWrongAnswer();
                            nekoponSound.playWrong();
                            
                            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                            if ('vibrate' in navigator) {
                                navigator.vibrate([100]);
                            }
                        }
                        updateStats();
                        
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `æ­£è§£ã§ã™ï¼${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `ä¸æ­£è§£ã§ã™ã€‚æ­£è§£ã¯ã€Œ${quiz.opts[quiz.ans]}ã€ã§ã—ãŸã€‚${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });

            nextBtn.onclick = () => {
                nekoponSound.playClick();
                loadNextQuiz();
            };

            backBtn.onclick = () => {
                nekoponSound.playClick();
                modal.classList.remove('show');
                showNotification('ãŠç–²ã‚Œæ§˜ã§ã—ãŸ');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) return;

            if (usedQuestions.length >= allProblems.length && questionMode === 'random') {
                usedQuestions = [];
                showNotification('å…¨å•ã‚¯ãƒªã‚¢ï¼å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('å…¨å•é¡Œã‚’ä¸€å‘¨ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<span>${txt}</span>`;
                btn.className = 'quiz-option w-full';
                
                // ç”Ÿãç‰©ã‚‰ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                addOrganicTapEffect(btn);
                
                btn.onclick = () => {
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        
                        if (i === quiz.ans) {
                            correctCount++;
                            gameification.onCorrectAnswer();
                            nekoponSound.playCorrect();
                            showNotification('æ­£è§£ã§ã™ï¼');
                            createParticle('âœ“', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
                            
                            if ('vibrate' in navigator) {
                                navigator.vibrate([50, 25, 50]);
                            }
                        } else {
                            wrongCount++;
                            gameification.onWrongAnswer();
                            nekoponSound.playWrong();
                            
                            if ('vibrate' in navigator) {
                                navigator.vibrate([100]);
                            }
                        }
                        updateStats();
                        
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `æ­£è§£ã§ã™ï¼${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `ä¸æ­£è§£ã§ã™ã€‚æ­£è§£ã¯ã€Œ${quiz.opts[quiz.ans]}ã€ã§ã—ãŸã€‚${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });
        }

        /* ----------------- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ----------------- */
        function initEventListeners() {
            // ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã®ã‚¿ãƒƒãƒ—
            document.getElementById('mainTitle').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playTitleBounce();
                document.getElementById('mainTitle').classList.add('title-bounce');
                
                setTimeout(() => {
                    document.getElementById('mainTitle').classList.remove('title-bounce');
                }, 600);
            });

            // çŒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ãƒƒãƒ—
            document.getElementById('leftCat').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playCatBounce();
                document.getElementById('leftCat').classList.add('bounce');
                
                setTimeout(() => {
                    document.getElementById('leftCat').classList.remove('bounce');
                }, 500);
            });

            document.getElementById('rightCat').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playCatBounce();
                document.getElementById('rightCat').classList.add('bounce');
                
                setTimeout(() => {
                    document.getElementById('rightCat').classList.remove('bounce');
                }, 500);
            });

            // ã‚¹ã‚³ã‚¢é …ç›®ã‚¿ãƒƒãƒ—
            document.getElementById('correctCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                createParticle('âœ“', '#10b981', e.clientX, e.clientY);
            });

            document.getElementById('wrongCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                createParticle('âœ—', '#ef4444', e.clientX, e.clientY);
            });

            document.getElementById('totalCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                createParticle('ğŸ“Š', '#8b4513', e.clientX, e.clientY);
            });

            document.getElementById('comboCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                createParticle('ğŸ”¥', '#ff7f50', e.clientX, e.clientY);
            });

            // ãƒ¡ã‚¤ãƒ³æ•™ç§‘é¸æŠ
            document.querySelectorAll('[data-subject]').forEach(btn => {
                addOrganicTapEffect(btn, 'subject');
                btn.addEventListener('click', (e) => {
                    const subject = e.currentTarget.dataset.subject;
                    hideAllModals();
                    document.getElementById(subject + 'Modal').classList.add('show');
                });
            });

            // è©³ç´°ã‚«ãƒ†ã‚´ãƒªé¸æŠ
            document.querySelectorAll('[data-category]').forEach(btn => {
                addOrganicTapEffect(btn, 'subject');
                btn.addEventListener('click', (e) => {
                    const category = e.currentTarget.dataset.category;
                    selectedCategories = [];
                    hideAllModals();
                    
                    const modalId = category.split('_')
                        .map((word, index) => index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1))
                        .join('');
                    
                    document.getElementById(modalId + 'Modal').classList.add('show');
                });
            });

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ç¾¤
            const startButtons = [
                'startGeographyQuiz', 'startHistoryQuiz', 'startCivicsQuiz',
                'startChemistryQuiz', 'startBiologyQuiz', 'startPhysicsQuiz', 'startEarthQuiz',
                'startEnglishWordsQuiz', 'startEnglishPhrasesQuiz', 'startEnglishGrammarQuiz'
            ];

            const subjectNames = [
                'ğŸ—ºï¸ åœ°ç†', 'ğŸ›ï¸ æ­´å²', 'âš–ï¸ å…¬æ°‘',
                'ğŸ§ª åŒ–å­¦', 'ğŸ§¬ ç”Ÿç‰©', 'âš›ï¸ ç‰©ç†', 'ğŸŒ åœ°å­¦',
                'ğŸ“ è‹±å˜èª', 'ğŸ’¬ è‹±ç†Ÿèª', 'ğŸ“˜ èªå½¢å¤‰åŒ–'
            ];

            startButtons.forEach((buttonId, index) => {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    addOrganicTapEffect(btn);
                    btn.addEventListener('click', () => {
                        nekoponSound.playClick();
                        startSelectedQuiz(buttonId.replace('start', '').replace('Quiz', '').toLowerCase(), subjectNames[index]);
                    });
                }
            });

            // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            const mainStartBtn = document.getElementById('startQuizButton');
            addOrganicTapEffect(mainStartBtn);
            mainStartBtn.addEventListener('click', () => {
                nekoponSound.playClick();
                openQuiz();
            });

            // å‡ºé¡Œå½¢å¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            const randomBtn = document.getElementById('randomModeBtn');
            const sequentialBtn = document.getElementById('sequentialModeBtn');
            
            addOrganicTapEffect(randomBtn, 'category');
            addOrganicTapEffect(sequentialBtn, 'category');
            
            randomBtn.addEventListener('click', () => {
                setQuestionMode('random');
            });
            
            sequentialBtn.addEventListener('click', () => {
                setQuestionMode('sequential');
            });

            // æ•™ç§‘å¤‰æ›´ãƒœã‚¿ãƒ³
            const changeBtn = document.getElementById('changeSubject');
            addOrganicTapEffect(changeBtn);
            changeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                gameification.reset();
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
                showNotification('æ•™ç§‘é¸æŠã«æˆ»ã‚Šã¾ã—ãŸ');
            });

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŸã¡
            document.querySelectorAll('.back-button').forEach(btn => {
                addOrganicTapEffect(btn, 'category');
            });

            // ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ãŸã¡
            document.querySelectorAll('.clean-button').forEach(btn => {
                addOrganicTapEffect(btn);
            });
        }

        /* ----------------- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆç°¡ç´ ç‰ˆï¼‰ ----------------- */
        class NekoponProgress {
            constructor() {
                this.storageKey = 'nekopon-quiz-progress';
                this.loadProgress();
            }

            saveProgress() {
                const progressData = {
                    totalQuestions: totalCount,
                    correctAnswers: correctCount,
                    wrongAnswers: wrongCount,
                    playerLevel: gameification.playerLevel,
                    totalExperience: gameification.totalExperience,
                    maxCombo: gameification.maxCombo,
                    lastPlayed: new Date().toISOString()
                };

                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(progressData));
                } catch (e) {
                    console.log('Progress save failed:', e);
                }
            }

            loadProgress() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        const progressData = JSON.parse(saved);
                        
                        // ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                        gameification.playerLevel = progressData.playerLevel || 1;
                        gameification.totalExperience = progressData.totalExperience || 0;
                        gameification.maxCombo = progressData.maxCombo || 0;
                        
                        // ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ã®æ›´æ–°
                        gameification.updateLevelBadges();
                        
                        // å¾©å¸°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        if (progressData.lastPlayed) {
                            const daysSinceLastPlay = Math.floor(
                                (new Date() - new Date(progressData.lastPlayed)) / (1000 * 60 * 60 * 24)
                            );
                            
                            if (daysSinceLastPlay === 0) {
                                showNotification('ãŠã‹ãˆã‚Šãªã•ã„ï¼ä»Šæ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†');
                            } else if (daysSinceLastPlay === 1) {
                                showNotification('æ˜¨æ—¥ã¶ã‚Šã§ã™ã­ï¼');
                            } else if (daysSinceLastPlay > 1) {
                                showNotification(`${daysSinceLastPlay}æ—¥ã¶ã‚Šã§ã™ã­ï¼`);
                            }
                        }
                    }
                } catch (e) {
                    console.log('Progress load failed:', e);
                }
            }

            // å®šæœŸä¿å­˜
            startAutoSave() {
                setInterval(() => {
                    this.saveProgress();
                }, 30000); // 30ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜
            }
        }

        const progressManager = new NekoponProgress();

        /* ----------------- åˆæœŸåŒ–ã¨ãƒ¡ã‚¤ãƒ³å‡¦ç† ----------------- */
        document.addEventListener('DOMContentLoaded', () => {
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã®åˆæœŸåŒ–
            initCategorySelection();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
            initEventListeners();
            
            // è‡ªå‹•ä¿å­˜é–‹å§‹
            progressManager.startAutoSave();
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹
            document.getElementById('changeSubject').classList.add('hidden');

            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
            document.addEventListener('click', () => {
                if (nekoponSound.audioContext && nekoponSound.audioContext.state === 'suspended') {
                    nekoponSound.audioContext.resume();
                }
            }, { once: true });

            // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
            if ('speechSynthesis' in window && typeof speechSynthesis.getVoices === 'function') {
                const voicePolling = setInterval(() => {
                    if (speechSynthesis.getVoices().length) {
                        clearInterval(voicePolling);
                    } else {
                        speechSynthesis.getVoices(); 
                    }
                }, 200);
            }

            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ä¿å­˜
            window.addEventListener('beforeunload', () => {
                progressManager.saveProgress();
            });

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œä¿®æ­£ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®šã‚’è©³ç´°ã«
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.overflowY = 'auto';
                modal.style.webkitOverflowScrolling = 'touch';
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
                modal.addEventListener('scroll', (e) => {
                    e.stopPropagation();
                }, { passive: true });
            });

            // åˆæœŸãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸è¡¨ç¤º
            gameification.updateLevelBadges();

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢é€£ã®è¿½åŠ ä¿®æ­£
            setTimeout(() => {
                // iOS Safariã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œå¯¾ç­–
                document.querySelectorAll('.modal .grid').forEach(grid => {
                    grid.style.webkitOverflowScrolling = 'touch';
                    grid.style.overflowY = 'auto';
                    grid.style.maxHeight = '60vh';
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
                    if (window.innerWidth > 640) {
                        grid.style.paddingRight = '8px';
                    }
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ãã®é–‰ã˜ã‚‹æ©Ÿèƒ½
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            // ãƒ¡ã‚¤ãƒ³æ•™ç§‘é¸æŠä»¥å¤–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                            if (modal.id !== 'mainSubjectModal') {
                                nekoponSound.playClick();
                                modal.classList.remove('show');
                            }
                        }
                    });
                });
            }, 100);

            // åˆå›ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            setTimeout(() => {
                if (!localStorage.getItem('nekopon-first-visit')) {
                    showNotification('NEKOPON Quizã¸ã‚ˆã†ã“ãï¼å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†');
                    localStorage.setItem('nekopon-first-visit', 'true');
                }
            }, 1000);
        });

        /* ----------------- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ– ----------------- */
        window.addEventListener('error', (e) => {
            console.error('NEKOPON Quiz Error:', e.error);
            showNotification('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled Promise Rejection:', e.reason);
            showNotification('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.nekoponGame = gameification;
        window.nekoponSound = nekoponSound;
        window.nekoponProgress = progressManager;
    </script>
</body>
</html>