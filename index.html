<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>üêæ NEKOPON Quiz üêæ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        :root {
            --primary-orange: #d2691e;
            --primary-coral: #ff7f50;
            --primary-brown: #8b4513;
            --accent-pink: #ff69b4;
            --accent-gold: #ffd700;
            --accent-cyan: #00ced1;
            --bg-cream: #faf8f5;
            --bg-white: #ffffff;
            --text-brown: #8b4513;
            --text-orange: #d2691e;
            --border-light: #f4e4bc;
            --shadow-warm: rgba(139,69,19,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: linear-gradient(135deg, #faf8f5 0%, #f5f0e8 50%, #faf8f5 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: var(--text-brown);
            font-weight: 700;
            position: relative;
        }

        /* „Çø„Ç§„Éà„É´„Çπ„Çø„Ç§„É´ */
        .game-title {
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            font-size: clamp(2rem, 6vw, 3.5rem);
            color: var(--primary-orange);
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            text-shadow: 3px 3px 12px rgba(139,69,19,0.2);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            animation: title-breathe 4s ease-in-out infinite;
        }

        .game-title:hover {
            transform: scale(1.05);
        }

        .game-title.title-bounce {
            animation: title-mega-bounce 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes title-breathe {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.02); filter: brightness(1.1) drop-shadow(0 0 15px rgba(255,215,0,0.3)); }
        }

        @keyframes title-mega-bounce {
            0% { transform: scale(1) rotate(0deg); }
            15% { transform: scale(1.2) rotate(5deg); filter: brightness(1.5) drop-shadow(0 0 20px gold); }
            30% { transform: scale(1.4) rotate(-3deg); filter: brightness(2) drop-shadow(0 0 25px orange); }
            45% { transform: scale(1.5) rotate(2deg); filter: brightness(2.5) drop-shadow(0 0 30px red); }
            60% { transform: scale(1.3) rotate(-1deg); filter: brightness(2) drop-shadow(0 0 25px pink); }
            75% { transform: scale(1.1) rotate(1deg); filter: brightness(1.5) drop-shadow(0 0 20px cyan); }
            85% { transform: scale(1.05) rotate(-0.5deg); filter: brightness(1.2); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }

        /* Áå´„Ç¢„Ç§„Ç≥„É≥ */
        .cat-icon {
            display: inline-block;
            cursor: pointer;
            font-size: 1.2em;
            margin: 0 12px;
            transition: transform 0.2s ease-out;
            animation: cat-sparkle 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 8px rgba(139,69,19,0.2));
        }

        .cat-icon:hover {
            transform: scale(1.3) rotate(15deg) !important;
            filter: drop-shadow(0 4px 12px rgba(255,105,180,0.4));
        }

        .cat-icon.bounce {
            animation: cat-mega-bounce 1s ease-in-out !important;
        }

        @keyframes cat-sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(3deg); filter: brightness(1.2); }
            50% { transform: scale(1.1) rotate(-2deg); filter: brightness(1.4); }
            75% { transform: scale(1.05) rotate(2deg); filter: brightness(1.2); }
        }

        @keyframes cat-mega-bounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.6) rotate(20deg); filter: brightness(2) hue-rotate(90deg); }
            50% { transform: scale(1.8) rotate(-15deg); filter: brightness(2.5) hue-rotate(180deg); }
            75% { transform: scale(1.4) rotate(10deg); filter: brightness(2) hue-rotate(270deg); }
        }

        /* ËÇâÁêÉ */
        .paw-icon {
            color: var(--accent-pink);
            font-size: 0.8em;
            margin: 0 8px;
            animation: paw-wiggle 2s ease-in-out infinite;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .paw-icon:hover {
            transform: scale(1.4) rotate(20deg);
            color: var(--accent-gold);
        }

        .paw-icon.tap-effect {
            animation: paw-explosion 0.8s ease-out !important;
        }

        @keyframes paw-wiggle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.05) rotate(-3deg); }
            75% { transform: scale(1.08) rotate(3deg); }
        }

        @keyframes paw-explosion {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            30% { transform: scale(2) rotate(180deg); filter: brightness(3) hue-rotate(120deg); }
            60% { transform: scale(2.5) rotate(270deg); filter: brightness(4) hue-rotate(240deg); }
            100% { transform: scale(1) rotate(360deg); filter: brightness(1); }
        }

        /* „Ç≥„É≥„ÉÜ„Éä */
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }

        @media (min-width: 640px) {
            .container-spacing { max-width: 500px; }
        }
        @media (min-width: 768px) {
            .container-spacing { max-width: 600px; }
        }
        @media (min-width: 1024px) {
            .container-spacing { max-width: 700px; }
        }

        /* „Ç´„Éº„Éâ */
        .clean-card {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 25px;
            box-shadow: 0 8px 32px var(--shadow-warm);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .clean-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-gold), var(--accent-cyan), var(--accent-pink));
            background-size: 200% 100%;
            animation: rainbow-flow 3s linear infinite;
        }

        @keyframes rainbow-flow {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* „Éú„Çø„É≥ */
        .clean-button {
            background: linear-gradient(145deg, var(--primary-orange), var(--primary-coral));
            border: none;
            color: white;
            font-weight: 700;
            border-radius: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(210,105,30,0.3);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .clean-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: width 0.3s ease, height 0.3s ease;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .clean-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .clean-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(210,105,30,0.4);
            background: linear-gradient(145deg, var(--primary-coral), #ff6347);
        }

        .clean-button:active {
            transform: translateY(-1px) scale(1.02);
            animation: button-joy 0.6s ease-out;
        }

        @keyframes button-joy {
            0% { transform: translateY(-1px) scale(1.02); }
            25% { transform: translateY(-5px) scale(1.08); filter: brightness(1.5); }
            50% { transform: translateY(-3px) scale(1.05); filter: brightness(1.8); }
            75% { transform: translateY(-4px) scale(1.06); filter: brightness(1.3); }
            100% { transform: translateY(-1px) scale(1.02); filter: brightness(1); }
        }

        /* ÊïôÁßë„Éú„Çø„É≥ */
        .subject-btn {
            background: var(--bg-white);
            border: 3px solid var(--border-light);
            border-radius: 20px;
            color: var(--text-brown);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 1.5rem 1rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px var(--shadow-warm);
            cursor: pointer;
            animation: subject-breathe 4s ease-in-out infinite;
        }

        .subject-btn:nth-child(2) { animation-delay: 0.5s; }
        .subject-btn:nth-child(3) { animation-delay: 1s; }

        @keyframes subject-breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px var(--shadow-warm); }
            50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(139,69,19,0.2); }
        }

        .subject-btn:hover {
            border-color: var(--primary-orange);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(210,105,30,0.3);
            background: linear-gradient(145deg, #fff8f0, #ffffff);
        }

        .subject-btn.active {
            background: linear-gradient(145deg, #fff0e6, #ffe4d1);
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255,127,80,0.4);
            animation: active-glow 2s ease-in-out infinite;
        }

        @keyframes active-glow {
            0%, 100% { box-shadow: 0 15px 35px rgba(255,127,80,0.4); }
            50% { box-shadow: 0 15px 35px rgba(255,127,80,0.6), 0 0 20px rgba(255,215,0,0.3); }
        }

        /* „Ç¢„Ç§„Ç≥„É≥ */
        .subject-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 2px 8px rgba(139,69,19,0.1));
        }

        .subject-btn:hover .subject-icon {
            transform: scale(1.2) rotate(10deg);
            filter: drop-shadow(0 4px 12px rgba(210,105,30,0.3));
        }

        .subject-name {
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        /* „Ç´„ÉÜ„Ç¥„É™„Éú„Çø„É≥ */
        .category-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 15px;
            color: var(--text-brown);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 70px;
            box-shadow: 0 3px 10px var(--shadow-warm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            animation: category-float 3s ease-in-out infinite;
        }

        .category-btn:nth-child(2n) { animation-delay: 0.3s; }
        .category-btn:nth-child(3n) { animation-delay: 0.6s; }

        @keyframes category-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        .category-btn:hover {
            border-color: var(--primary-orange);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(210,105,30,0.25);
            background: linear-gradient(145deg, #fff8f0, #ffffff);
        }

        .category-btn.active {
            background: linear-gradient(145deg, #ffe4d1, #ffd7b5);
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(255,127,80,0.35);
        }

        /* „ÇØ„Ç§„Ç∫„Ç™„Éó„Ç∑„Éß„É≥ */
        .quiz-option {
            background: var(--bg-white);
            border: 3px solid var(--border-light);
            color: var(--text-brown);
            border-radius: 15px;
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            box-shadow: 0 4px 15px var(--shadow-warm);
            cursor: pointer;
            overflow: hidden;
            animation: option-gentle-pulse 4s ease-in-out infinite;
        }

        .quiz-option:nth-child(2) { animation-delay: 0.3s; }
        .quiz-option:nth-child(3) { animation-delay: 0.6s; }
        .quiz-option:nth-child(4) { animation-delay: 0.9s; }

        @keyframes option-gentle-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px var(--shadow-warm); }
            50% { transform: scale(1.01); box-shadow: 0 6px 20px rgba(139,69,19,0.2); }
        }

        .quiz-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,215,0,0.3), rgba(255,127,80,0.2));
            border-radius: 50%;
            transition: width 0.4s ease, height 0.4s ease;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .quiz-option:hover::before {
            width: 300px;
            height: 300px;
        }

        .quiz-option:hover {
            border-color: var(--primary-orange);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 30px rgba(210,105,30,0.3);
            background: linear-gradient(145deg, #fff8f0, #ffffff);
        }

        .quiz-option span {
            position: relative;
            z-index: 1;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(139,69,19,0.6);
            backdrop-filter: blur(12px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            animation: modal-magical-enter 0.6s ease-out;
        }

        @keyframes modal-magical-enter {
            0% {
                opacity: 0;
                transform: scale(0.8) rotate(-10deg);
                filter: blur(10px);
            }
            60% {
                opacity: 1;
                transform: scale(1.05) rotate(2deg);
                filter: blur(0px);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
                filter: blur(0px);
            }
        }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ */
        .stats-display {
            background: linear-gradient(145deg, #fff8f0, #ffffff);
            border: 2px solid var(--border-light);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 6px 20px var(--shadow-warm);
            position: relative;
            overflow: hidden;
        }

        .stats-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.2), transparent);
            animation: stats-shine 3s ease-in-out infinite;
        }

        @keyframes stats-shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        /* „Çπ„Ç≥„Ç¢È†ÖÁõÆ */
        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-brown);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .score-value:hover {
            color: var(--primary-orange);
            transform: scale(1.1);
            filter: drop-shadow(0 2px 8px rgba(210,105,30,0.3));
        }

        .score-value.pulse {
            animation: score-celebration 0.8s ease-out;
        }

        @keyframes score-celebration {
            0% { transform: scale(1); filter: brightness(1); }
            25% { transform: scale(1.3); filter: brightness(2) drop-shadow(0 0 15px gold); }
            50% { transform: scale(1.5); filter: brightness(2.5) drop-shadow(0 0 20px orange); }
            75% { transform: scale(1.2); filter: brightness(2) drop-shadow(0 0 15px pink); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* „É¨„Éô„É´„Éª„Éê„ÉÉ„Ç∏„Ç∑„Çπ„ÉÜ„É† */
        .level-badge {
            display: inline-block;
            background: linear-gradient(145deg, var(--accent-gold), #ffb347);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            margin: 0.25rem;
            box-shadow: 0 4px 12px rgba(255,215,0,0.3);
            animation: badge-sparkle 2s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes badge-sparkle {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.3) drop-shadow(0 0 10px gold); }
        }

        .level-badge:hover {
            transform: scale(1.1) rotate(5deg);
            filter: brightness(1.5) drop-shadow(0 0 15px orange);
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, #fff8f0, #ffffff);
            border: 3px solid var(--accent-gold);
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(255,215,0,0.4);
            z-index: 2000;
            text-align: center;
            opacity: 0;
        }

        .achievement-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            animation: achievement-celebration 2s ease-out;
        }

        @keyframes achievement-celebration {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1.1) rotate(10deg); }
            60% { transform: translate(-50%, -50%) scale(1.05) rotate(-5deg); }
            80% { transform: translate(-50%, -50%) scale(1.02) rotate(2deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            font-size: 1.5rem;
            animation: particle-magic 2.5s ease-out forwards;
        }

        @keyframes particle-magic {
            0% {
                transform: translateY(0) scale(0) rotate(0deg);
                opacity: 1;
            }
            20% {
                transform: translateY(-20px) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            60% {
                transform: translateY(-60px) scale(1.5) rotate(360deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-120px) scale(2) rotate(720deg);
                opacity: 0;
            }
        }

        /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Çπ„Ç≥„Ç¢ */
        .floating-score {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 2rem;
            font-weight: 400;
            color: var(--accent-gold);
            pointer-events: none;
            z-index: 800;
            text-shadow: 2px 2px 8px rgba(139,69,19,0.3);
            animation: float-magical 3s ease-out forwards;
            white-space: nowrap;
        }

        .floating-score.combo {
            font-size: 2.5rem;
            color: var(--accent-pink);
            animation: float-combo 3.5s ease-out forwards;
        }

        .floating-score.perfect {
            font-size: 3rem;
            color: #ff1493;
            animation: float-perfect 4s ease-out forwards;
        }

        @keyframes float-magical {
            0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
            30% { opacity: 1; transform: translateY(-40px) scale(1.5) rotate(180deg); }
            70% { opacity: 0.8; transform: translateY(-80px) scale(2) rotate(360deg); }
            100% { opacity: 0; transform: translateY(-150px) scale(2.5) rotate(720deg); }
        }

        @keyframes float-combo {
            0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
            25% { opacity: 1; transform: translateY(-30px) scale(2) rotate(180deg); }
            50% { opacity: 1; transform: translateY(-70px) scale(2.5) rotate(360deg); }
            75% { opacity: 0.8; transform: translateY(-120px) scale(3) rotate(540deg); }
            100% { opacity: 0; transform: translateY(-200px) scale(4) rotate(1080deg); }
        }

        @keyframes float-perfect {
            0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
            20% { opacity: 1; transform: translateY(-20px) scale(2.5) rotate(180deg); }
            40% { opacity: 1; transform: translateY(-60px) scale(3.5) rotate(360deg); }
            60% { opacity: 1; transform: translateY(-100px) scale(4) rotate(540deg); }
            80% { opacity: 0.8; transform: translateY(-160px) scale(5) rotate(720deg); }
            100% { opacity: 0; transform: translateY(-250px) scale(6) rotate(1440deg); }
        }

        /* „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„Éâ */
        .fever-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,215,0,0.15) 0%, rgba(255,105,180,0.1) 100%);
            pointer-events: none;
            z-index: 50;
            animation: fever-magical 1s ease-in-out infinite alternate;
        }

        @keyframes fever-magical {
            0% { opacity: 0.3; background: radial-gradient(circle, rgba(255,215,0,0.15) 0%, rgba(255,105,180,0.1) 100%); }
            100% { opacity: 0.7; background: radial-gradient(circle, rgba(255,105,180,0.2) 0%, rgba(0,206,209,0.15) 100%); }
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏ */
        .msg {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-brown);
            pointer-events: none;
            z-index: 700;
            animation: msg-dance 3s ease-out forwards;
            text-shadow: 1px 1px 4px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        @keyframes msg-dance {
            0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
            25% { opacity: 1; transform: translateY(-20px) scale(1.3) rotate(5deg); }
            50% { opacity: 1; transform: translateY(-40px) scale(1.2) rotate(-3deg); }
            75% { opacity: 0.8; transform: translateY(-60px) scale(1.4) rotate(2deg); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.6) rotate(0deg); }
        }

        /* ÈÄöÁü• */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, var(--bg-white), #fff8f0);
            color: var(--text-brown);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            border: 2px solid var(--border-light);
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            box-shadow: 0 8px 32px var(--shadow-warm);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
            animation: notification-bounce 0.6s ease-out;
        }

        @keyframes notification-bounce {
            0% { transform: translateX(400px) rotate(10deg); }
            60% { transform: translateX(-20px) rotate(-2deg); }
            80% { transform: translateX(10px) rotate(1deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }

        /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éú„Çø„É≥ */
        .floating-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, var(--primary-orange), var(--primary-coral));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(210,105,30,0.4);
            transition: all 0.3s ease;
            z-index: 1002;
            cursor: pointer;
            animation: float-bob 3s ease-in-out infinite;
        }

        @keyframes float-bob {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }

        .floating-button:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 40px rgba(210,105,30,0.5);
            animation: none;
        }

        .floating-button.hidden {
            display: none !important;
        }

        /* „É¢„Éº„ÉâÈÅ∏Êäû„Éú„Çø„É≥ */
        .mode-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            color: var(--text-brown);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-warm);
            cursor: pointer;
        }

        .mode-btn:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(210,105,30,0.25);
        }

        .mode-btn.active {
            background: linear-gradient(145deg, #ffe4d1, #ffd7b5);
            border-color: var(--primary-coral);
            color: var(--primary-orange);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(255,127,80,0.35);
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 640px) {
            .game-title { font-size: clamp(1.5rem, 8vw, 2.5rem); }
            .cat-icon { font-size: 1em; margin: 0 8px; }
            .paw-icon { font-size: 0.7em; margin: 0 6px; }
            .subject-btn { padding: 1rem 0.75rem; min-height: 80px; }
            .category-btn { padding: 0.75rem 0.5rem; min-height: 60px; font-size: 0.8rem; }
            .quiz-option { padding: 0.75rem 1rem; font-size: 0.9rem; }
            .floating-button { width: 60px; height: 60px; font-size: 1.5rem; bottom: 25px; left: 25px; }
        }

        /* ËøΩÂä†: „ÇØ„Ç§„Ç∫Ë™¨Êòé„Ç®„É™„Ç¢ */
        .quiz-explanation {
            min-height: 120px;
            background: linear-gradient(145deg, #f8fafc, #ffffff);
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1rem;
            border: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
            transition: all 0.3s ease;
        }

        .quiz-explanation.has-content {
            border-color: var(--primary-coral);
            background: linear-gradient(145deg, #fff0e6, #ffe4d1);
            animation: explanation-glow 1s ease-out;
        }

        @keyframes explanation-glow {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.02); filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,127,80,0.3)); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .back-button {
            background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
            border: 2px solid var(--border-light);
            color: var(--text-brown);
            border-radius: 15px;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 3px 10px var(--shadow-warm);
        }

        .back-button:hover {
            background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139,69,19,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- „Çø„Ç§„Éà„É´ÈÉ®ÂàÜ -->
    <div class="text-center mb-4">
        <h1 class="game-title" id="mainTitle">
            <span class="cat-icon" id="leftCat">üê±</span>
            <span class="paw-icon" id="leftPaw">üêæ</span>
            NEKOPON Quiz
            <span class="paw-icon" id="rightPaw">üêæ</span>
            <span class="cat-icon" id="rightCat">üê±</span>
        </h1>
        <div id="levelBadges" class="mt-2"></div>
    </div>

    <!-- ÊïôÁßëÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="mainSubjectModal" class="modal show">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    üìö ÊïôÁßë„ÇíÈÅ∏Êäû„Åó„Å¶„Å´„ÇÉ„Äú
                </h2>
                <p class="text-orange-600 text-sm">„Å©„ÅÆÊïôÁßë„ÅßÈÅä„Å∂„ÅãÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-subject="social">
                    <div class="subject-icon">üåç</div>
                    <div class="subject-name">Á§æ‰ºö</div>
                </button>
                <button class="subject-btn" data-subject="science">
                    <div class="subject-icon">üî¨</div>
                    <div class="subject-name">ÁêÜÁßë</div>
                </button>
                <button class="subject-btn" data-subject="english">
                    <div class="subject-icon">üìñ</div>
                    <div class="subject-name">Ëã±Ë™û</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Á§æ‰ºöÂàÜÈáéÈÅ∏Êäû -->
    <div id="socialModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    üåç Á§æ‰ºö„ÅÆÂàÜÈáé„ÇíÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">„Å©„ÅÆÂàÜÈáé„ÅßÂ≠¶Áøí„Åô„Çã„ÅãÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-category="geography">
                    <div class="subject-icon">üó∫Ô∏è</div>
                    <div class="subject-name">Âú∞ÁêÜ</div>
                </button>
                <button class="subject-btn" data-category="history">
                    <div class="subject-icon">üèõÔ∏è</div>
                    <div class="subject-name">Ê≠¥Âè≤</div>
                </button>
                <button class="subject-btn" data-category="civics">
                    <div class="subject-icon">‚öñÔ∏è</div>
                    <div class="subject-name">ÂÖ¨Ê∞ë</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    ‚Üê ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ÁêÜÁßëÂàÜÈáéÈÅ∏Êäû -->
    <div id="scienceModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    üî¨ ÁêÜÁßë„ÅÆÂàÜÈáé„ÇíÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">„Å©„ÅÆÂàÜÈáé„ÅßÂ≠¶Áøí„Åô„Çã„ÅãÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button class="subject-btn" data-category="chemistry">
                    <div class="subject-icon">üß™</div>
                    <div class="subject-name">ÂåñÂ≠¶</div>
                </button>
                <button class="subject-btn" data-category="biology">
                    <div class="subject-icon">üß¨</div>
                    <div class="subject-name">ÁîüÁâ©</div>
                </button>
                <button class="subject-btn" data-category="physics">
                    <div class="subject-icon">‚öõÔ∏è</div>
                    <div class="subject-name">Áâ©ÁêÜ</div>
                </button>
                <button class="subject-btn" data-category="earth">
                    <div class="subject-icon">üåç</div>
                    <div class="subject-name">Âú∞Â≠¶</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    ‚Üê ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Ëã±Ë™ûÂàÜÈáéÈÅ∏Êäû -->
    <div id="englishModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold mb-3 text-orange-700">
                    üìñ Ëã±Ë™û„ÅÆÂàÜÈáé„ÇíÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">„Å©„ÅÆÂàÜÈáé„ÅßÂ≠¶Áøí„Åô„Çã„ÅãÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™</p>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="subject-btn" data-category="english_words">
                    <div class="subject-icon">üìù</div>
                    <div class="subject-name">Ëã±ÂçòË™û</div>
                </button>
                <button class="subject-btn" data-category="english_phrases">
                    <div class="subject-icon">üí¨</div>
                    <div class="subject-name">Ëã±ÁÜüË™û</div>
                </button>
                <button class="subject-btn" data-category="english_grammar">
                    <div class="subject-icon">üìò</div>
                    <div class="subject-name">Ë™ûÂΩ¢Â§âÂåñ</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    ‚Üê ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ÔºàÂú∞ÁêÜÔºâ -->
    <div id="geographyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üó∫Ô∏è Âú∞ÁêÜ„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="geographyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startGeographyQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    ‚Üê Á§æ‰ºö„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ‰ªñ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„É¢„Éº„ÉÄ„É´„ÇÇÂêåÊßò„Å´... -->
    <!-- Ê≠¥Âè≤ -->
    <div id="historyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üèõÔ∏è Ê≠¥Âè≤„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="historyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startHistoryQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    ‚Üê Á§æ‰ºö„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ÂÖ¨Ê∞ë -->
    <div id="civicsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ‚öñÔ∏è ÂÖ¨Ê∞ë„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="civicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startCivicsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    ‚Üê Á§æ‰ºö„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ÂåñÂ≠¶ -->
    <div id="chemistryModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üß™ ÂåñÂ≠¶„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="chemistryCategories"></div>
            <div class="text-center space-y-2">
                <button id="startChemistryQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    ‚Üê ÁêÜÁßë„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ÁîüÁâ© -->
    <div id="biologyModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üß¨ ÁîüÁâ©„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="biologyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startBiologyQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    ‚Üê ÁêÜÁßë„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Áâ©ÁêÜ -->
    <div id="physicsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    ‚öõÔ∏è Áâ©ÁêÜ„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="physicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startPhysicsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    ‚Üê ÁêÜÁßë„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Âú∞Â≠¶ -->
    <div id="earthModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üåç Âú∞Â≠¶„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="earthCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEarthQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    ‚Üê ÁêÜÁßë„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Ëã±ÂçòË™û -->
    <div id="englishWordsModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üìù Ëã±ÂçòË™û„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishWordsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishWordsQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    ‚Üê Ëã±Ë™û„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Ëã±ÁÜüË™û -->
    <div id="englishPhrasesModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üí¨ Ëã±ÁÜüË™û„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishPhrasesCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishPhrasesQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    ‚Üê Ëã±Ë™û„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Ë™ûÂΩ¢Â§âÂåñ -->
    <div id="englishGrammarModal" class="modal">
        <div class="clean-card p-6 container-spacing">
            <div class="text-center mb-4">
                <h2 class="text-lg font-bold mb-3 text-orange-700">
                    üìò Ë™ûÂΩ¢Â§âÂåñ„ÅÆÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-orange-600 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚ô™<br>Ë§áÊï∞ÈÅ∏Êäû„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ</p>
            </div>
            <div class="grid grid-cols-1 gap-2 mb-4" id="englishGrammarCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishGrammarQuiz" class="clean-button px-6 py-3 text-sm" disabled>
                    üéØ „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    ‚Üê Ëã±Ë™û„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="gameScreen" class="hidden">
        <div class="clean-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title">üêæ NEKOPON Quiz üêæ</h1>
            <div id="currentCategory" class="text-lg font-bold text-orange-700 mb-4"></div>
            
            <div class="stats-display">
                <div class="grid grid-cols-4 gap-4 text-center mb-4">
                    <div>
                        <div class="score-value" id="correctCount">0</div>
                        <div class="text-xs text-orange-600">Ê≠£Ëß£Êï∞</div>
                    </div>
                    <div>
                        <div class="score-value" id="wrongCount">0</div>
                        <div class="text-xs text-orange-600">‰∏çÊ≠£Ëß£Êï∞</div>
                    </div>
                    <div>
                        <div class="score-value" id="totalCount">0</div>
                        <div class="text-xs text-orange-600">Á∑èÂïèÈ°åÊï∞</div>
                    </div>
                    <div>
                        <div class="score-value" id="comboCount">0</div>
                        <div class="text-xs text-orange-600">ÈÄ£Á∂öÊ≠£Ëß£</div>
                    </div>
                </div>
                
                <div class="h-px bg-orange-200 my-4"></div>
                
                <div class="text-center">
                    <div class="text-sm font-bold text-orange-700 mb-3">üìã Âá∫È°åÂΩ¢Âºè</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                            üé≤ „É©„É≥„ÉÄ„É†
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                            üìã È†ÜÁï™ÈÄö„Çä
                        </button>
                    </div>
                    <div class="text-xs text-orange-600 mt-2" id="modeDescription">
                        ÂïèÈ°å„Çí„É©„É≥„ÉÄ„É†„Å´Âá∫È°å„Åó„Åæ„Åô
                    </div>
                </div>
            </div>
            
            <button id="startQuizButton" class="clean-button px-8 py-4 text-lg font-bold mt-6">
                ‚ú® „ÇØ„Ç§„Ç∫ÈñãÂßã„Å´„ÇÉ„ÄúÔºÅ ‚ú®
            </button>
        </div>
    </div>

    <!-- „ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´ -->
    <div id="quizModal" class="modal">
        <div class="clean-card p-6 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-bold text-xl text-orange-700">
                    üêæ NEKOPON Quiz üêæ
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-lg font-bold text-center text-orange-800 leading-relaxed"></p>
                <div id="quizOptions" class="space-y-3"></div>
                <div id="quizExplanation" class="quiz-explanation">
                    <p id="quizMsg" class="font-bold text-center text-lg"></p>
                </div>
                <div class="flex gap-3">
                    <button id="quizNext" class="flex-1 clean-button py-3 text-sm">
                        üåü Ê¨°„ÅÆÂïèÈ°å„Å´„ÇÉ„Äú
                    </button>
                    <button id="quizBack" class="flex-1 back-button py-3 text-sm">
                        üè† Êàª„Çã„Å´„ÇÉ„Äú
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éú„Çø„É≥ -->
    <button id="changeSubject" class="floating-button hidden">
        üìö
    </button>

    <!-- ÈÄöÁü• -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üê±</span>
            <div>
                <div class="font-bold text-sm">NEKOPON Quiz</div>
                <div id="notificationText" class="text-xs text-orange-600"></div>
            </div>
        </div>
    </div>

    <!-- ÈÅîÊàê„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
    <div id="achievementPopup" class="achievement-popup">
        <div class="text-6xl mb-4" id="achievementIcon">üèÜ</div>
        <div class="text-xl font-bold text-orange-700 mb-2" id="achievementTitle">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div>
        <div class="text-sm text-orange-600" id="achievementDescription">Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÊûú„Åß„ÅôÔºÅ</div>
        <button class="clean-button px-6 py-2 mt-4" onclick="closeAchievement()">
            „ÅÇ„Çä„Åå„Å®„ÅÜ„Å´„ÇÉ„ÄúÔºÅ
        </button>
    </div>

    <script>
        /* ----------------- NEKOPONÈ¢® ÂäπÊûúÈü≥„Ç∑„Çπ„ÉÜ„É† ----------------- */
        class NekoponSoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            }

            // Âü∫Êú¨Èü≥„ÅÆÁîüÊàê
            createTone(frequency, duration, volume = 0.3, type = 'sine') {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const filterNode = this.audioContext.createBiquadFilter();

                oscillator.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                filterNode.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);
                filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÈü≥ÔºàÂèØÊÑõ„Çâ„Åó„ÅèÔºâ
            playClick() {
                this.createTone(800, 0.1, 0.15, 'square');
                setTimeout(() => this.createTone(1000, 0.05, 0.1, 'square'), 50);
            }

            // Ê≠£Ëß£Èü≥ÔºàË±™ËèØ„Å™„É°„É≠„Éá„Ç£„ÉºÔºâ
            playCorrect() {
                const melody = [523, 659, 784, 1047]; // „Éâ„Éª„Éü„Éª„ÇΩ„Éª„Éâ
                melody.forEach((freq, i) => {
                    setTimeout(() => {
                        this.createTone(freq, 0.3, 0.2);
                        if (i === melody.length - 1) {
                            // ÊúÄÂæå„ÅÆÈü≥„Å´„Éè„Éº„É¢„Éã„ÉºËøΩÂä†
                            setTimeout(() => this.createTone(freq * 1.25, 0.5, 0.15), 100);
                        }
                    }, i * 150);
                });
            }

            // ‰∏çÊ≠£Ëß£Èü≥ÔºàÂÑ™„Åó„ÅèÔºâ
            playWrong() {
                this.createTone(300, 0.2, 0.2, 'triangle');
                setTimeout(() => this.createTone(250, 0.3, 0.15, 'triangle'), 200);
            }

            // „Ç≥„É≥„ÉúÈü≥ÔºàÈÄ£Á∂öÊ≠£Ëß£ÊôÇÔºâ
            playCombo(comboCount) {
                const baseFreq = 600;
                for (let i = 0; i < Math.min(comboCount, 5); i++) {
                    setTimeout(() => {
                        this.createTone(baseFreq + i * 200, 0.2, 0.15);
                    }, i * 80);
                }
            }

            // ÂÆåÁíßÈü≥Ôºà„Éï„Ç£„Éº„Éê„ÉºÊôÇÔºâ
            playPerfect() {
                const frequencies = [523, 587, 659, 698, 784, 880, 988, 1047, 1175, 1319];
                frequencies.forEach((freq, i) => {
                    setTimeout(() => {
                        this.createTone(freq, 0.4, 0.12);
                        // „Éè„Éº„É¢„Éã„ÉºËøΩÂä†
                        setTimeout(() => this.createTone(freq * 1.25, 0.3, 0.08), 50);
                    }, i * 80);
                });
            }

            // „Çø„Ç§„Éà„É´„Çø„ÉÉ„ÉóÈü≥ÔºàÁâπÂà•Ôºâ
            playTitleBounce() {
                this.createTone(800, 0.4, 0.2);
                setTimeout(() => this.createTone(1200, 0.6, 0.18), 200);
                setTimeout(() => this.createTone(1600, 0.8, 0.15), 400);
                setTimeout(() => this.createTone(2000, 1.0, 0.12), 600);
            }

            // ËÇâÁêÉ„Çø„ÉÉ„ÉóÈü≥
            playPawTap() {
                this.createTone(600, 0.15, 0.2, 'sine');
                setTimeout(() => this.createTone(800, 0.1, 0.15, 'sine'), 75);
                setTimeout(() => this.createTone(1000, 0.08, 0.1, 'sine'), 125);
            }

            // Áå´„Ç¢„Ç§„Ç≥„É≥„Çø„ÉÉ„ÉóÈü≥
            playCatBounce() {
                this.createTone(700, 0.3, 0.18, 'triangle');
                setTimeout(() => this.createTone(900, 0.2, 0.15, 'triangle'), 150);
                setTimeout(() => this.createTone(1100, 0.15, 0.12, 'triangle'), 250);
            }

            // Ëã±Ë™ûÁô∫Èü≥ÊôÇ„ÅÆÂèØÊÑõ„ÅÑÂäπÊûúÈü≥
            playEnglishSound() {
                this.createTone(400, 0.1, 0.12, 'sine');
                setTimeout(() => this.createTone(500, 0.08, 0.1, 'sine'), 50);
            }

            // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÈü≥
            playLevelUp() {
                const notes = [523, 659, 784, 1047, 1319, 1568];
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        this.createTone(freq, 0.5, 0.15);
                        // „Ç®„Ç≥„ÉºÂäπÊûú
                        setTimeout(() => this.createTone(freq, 0.3, 0.08), 100);
                    }, i * 100);
                });
            }

            // ÈÅîÊàêÈü≥
            playAchievement() {
                this.playPerfect();
                setTimeout(() => this.playLevelUp(), 500);
            }
        }

        const nekoponSound = new NekoponSoundSystem();

        /* ----------------- Èü≥Â£∞Áô∫Èü≥„Ç∑„Çπ„ÉÜ„É†ÔºàÊîπËâØÁâàÔºâ ----------------- */
        function speakWord(wordToSpeak) {
            if (!('speechSynthesis' in window) || !wordToSpeak) return;
            
            // ÂèØÊÑõ„ÅÑÂäπÊûúÈü≥„ÇíÂÖà„Å´ÂÜçÁîü
            nekoponSound.playEnglishSound();
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                const voices = speechSynthesis.getVoices();
                let preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang) && (v.name.includes('Google') || v.localService || v.default));
                if (!preferredVoice) preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang));
               
                utterance.voice = preferredVoice || voices.find(v => v.lang && v.lang.startsWith('en-')); 
                utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
                utterance.rate = 0.9; 
                utterance.pitch = 1;
                speechSynthesis.cancel(); 
                speechSynthesis.speak(utterance);
            }, 200);
        }

        function isEnglishCategory() {
            return selectedCategories.some(categoryId => 
                categoryId.startsWith('words_') || categoryId.startsWith('phrases_') || categoryId.startsWith('grammar_')
            );
        }

        /* ----------------- „Ç≤„Éº„Éü„Éï„Ç£„Ç±„Éº„Ç∑„Éß„É≥ „Ç∑„Çπ„ÉÜ„É† ----------------- */
        class NekoponGameification {
            constructor() {
                this.playerLevel = 1;
                this.totalExperience = 0;
                this.achievements = new Set();
                this.comboCount = 0;
                this.maxCombo = 0;
                this.feverMode = false;
                this.perfectStreak = 0;

                this.achievementDefinitions = [
                    { id: 'first_correct', name: 'ÂàùÊ≠£Ëß£', description: 'ÊúÄÂàù„ÅÆÊ≠£Ëß£ÔºÅ', icon: 'üéØ', requirement: 1 },
                    { id: 'combo_3', name: '3ÈÄ£Á∂ö', description: '3ÂïèÈÄ£Á∂öÊ≠£Ëß£', icon: 'üî•', requirement: 3 },
                    { id: 'combo_5', name: '5ÈÄ£Á∂ö', description: '5ÂïèÈÄ£Á∂öÊ≠£Ëß£', icon: '‚ö°', requirement: 5 },
                    { id: 'combo_10', name: '10ÈÄ£Á∂ö', description: '10ÂïèÈÄ£Á∂öÊ≠£Ëß£', icon: 'üåü', requirement: 10 },
                    { id: 'total_50', name: 'ÂïèÈ°å„Éû„Çπ„Çø„Éº', description: 'Á∑èÂïèÈ°åÊï∞50ÂïèÈÅîÊàê', icon: 'üèÜ', requirement: 50 },
                    { id: 'total_100', name: '„ÇØ„Ç§„Ç∫„Ç≠„É≥„Ç∞', description: 'Á∑èÂïèÈ°åÊï∞100ÂïèÈÅîÊàê', icon: 'üëë', requirement: 100 },
                    { id: 'level_5', name: '„É¨„Éô„É´5', description: '„É¨„Éô„É´5Âà∞ÈÅî', icon: '‚≠ê', requirement: 5 },
                    { id: 'level_10', name: '„É¨„Éô„É´10', description: '„É¨„Éô„É´10Âà∞ÈÅî', icon: 'üí´', requirement: 10 },
                    { id: 'perfect_day', name: 'ÂÆåÁíß„Å™Êó•', description: 'Ê≠£Á≠îÁéá100%„ÇíÈÅîÊàê', icon: 'üåà', requirement: 1 }
                ];

                this.cuteMessages = [
                    '„Åô„Åî„ÅÑ„Å´„ÇÉ„ÄúÔºÅ', '„ÇÑ„Å£„Åü„Å´„ÇÉÔºÅ', '„Åã„Åó„Åì„ÅÑ„Å´„ÇÉ„ÄúÔºÅ', '„Åï„Åô„Åå„Å´„ÇÉÔºÅ', 
                    '„Å∞„Å£„Å°„Çä„Å´„ÇÉ„ÄúÔºÅ', '„Åà„Çâ„ÅÑ„Å´„ÇÉÔºÅ', '„Åç„ÇÉ„Çè„ÅÑ„ÅÑ„Äú‚ô™', '„ÇÇ„Åµ„ÇÇ„Åµ„ÄúÔºÅ',
                    '„Å∫„Çç„Å∫„Çç„Äú‚ô™', '„Å´„ÇÉ„Çì„Å´„ÇÉ„Çì‚ô™', '„ÅÜ„Çå„Åó„ÅÑ„Å´„ÇÉ„ÄúÔºÅ', '„Å†„ÅÑ„Åô„Åç„Å´„ÇÉ„ÄúÔºÅ'
                ];

                this.comboMessages = [
                    '„Çå„Çì„Åû„Åè„ÄúÔºÅ', '„Åô„Åî„Åô„Åé„Çã„Å´„ÇÉÔºÅ', '„Åß„Çì„Åõ„Å§„Å´„ÇÉ„ÄúÔºÅ', '„Åã„Åø„Å´„ÇÉ„ÇìÔºÅ',
                    '„Åï„ÅÑ„Åç„Çá„ÅÜ„Å´„ÇÉ„ÄúÔºÅ', '„ÅÇ„Çä„Åà„Å™„ÅÑ„Å´„ÇÉÔºÅ', '„Å¶„Çì„Åï„ÅÑ„Å´„ÇÉ„ÄúÔºÅ', '„Åô„Å¶„Åç„Å´„ÇÉ‚ô™'
                ];
            }

            // Ê≠£Ëß£ÊôÇ„ÅÆÂá¶ÁêÜ
            onCorrectAnswer() {
                this.comboCount++;
                this.maxCombo = Math.max(this.maxCombo, this.comboCount);
                this.totalExperience += 10;
                this.perfectStreak++;

                // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂà§ÂÆö
                const newLevel = Math.floor(this.totalExperience / 100) + 1;
                if (newLevel > this.playerLevel) {
                    this.playerLevel = newLevel;
                    this.triggerLevelUp();
                }

                // „Ç≥„É≥„ÉúÂäπÊûú
                if (this.comboCount >= 3) {
                    this.triggerComboEffect();
                }

                // „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâÂà§ÂÆö
                if (this.comboCount >= 5 && !this.feverMode) {
                    this.enterFeverMode();
                }

                // ÈÅîÊàêÂà§ÂÆö
                this.checkAchievements();

                this.updateDisplay();
            }

            // ‰∏çÊ≠£Ëß£ÊôÇ„ÅÆÂá¶ÁêÜ
            onWrongAnswer() {
                this.comboCount = 0;
                this.perfectStreak = 0;
                this.exitFeverMode();
                this.updateDisplay();
            }

            // „É¨„Éô„É´„Ç¢„ÉÉ„Éó
            triggerLevelUp() {
                nekoponSound.playLevelUp();
                this.showAchievement('„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ', `„É¨„Éô„É´ ${this.playerLevel} „Å´Âà∞ÈÅî„Åó„Åæ„Åó„ÅüÔºÅ`, 'üåü');
                this.updateLevelBadges();
                
                // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200, 100, 300]);
                }
            }

            // „Ç≥„É≥„Éú„Ç®„Éï„Çß„ÇØ„Éà
            triggerComboEffect() {
                nekoponSound.playCombo(this.comboCount);
                
                const comboMessage = this.comboMessages[Math.min(this.comboCount - 3, this.comboMessages.length - 1)];
                this.showFloatingMessage(`${this.comboCount}ÈÄ£Á∂öÔºÅ\n${comboMessage}`, 'combo');
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
                this.createComboParticles();
            }

            // „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâÈñãÂßã
            enterFeverMode() {
                this.feverMode = true;
                nekoponSound.playPerfect();
                
                // „Éï„Ç£„Éº„Éê„ÉºËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà
                const feverBg = document.createElement('div');
                feverBg.className = 'fever-mode';
                feverBg.id = 'feverBackground';
                document.body.appendChild(feverBg);
                
                this.showFloatingMessage('„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†ÔºÅ', 'perfect');
                
                // 5ÁßíÂæå„Å´Ëá™ÂãïÁµÇ‰∫Ü
                setTimeout(() => this.exitFeverMode(), 5000);
            }

            // „Éï„Ç£„Éº„Éê„Éº„É¢„Éº„ÉâÁµÇ‰∫Ü
            exitFeverMode() {
                this.feverMode = false;
                const feverBg = document.getElementById('feverBackground');
                if (feverBg) {
                    feverBg.remove();
                }
            }

            // ÈÅîÊàêÂà§ÂÆö
            checkAchievements() {
                this.achievementDefinitions.forEach(achievement => {
                    if (this.achievements.has(achievement.id)) return;

                    let achieved = false;
                    switch (achievement.id) {
                        case 'first_correct':
                            achieved = correctCount >= 1;
                            break;
                        case 'combo_3':
                        case 'combo_5':
                        case 'combo_10':
                            achieved = this.comboCount >= achievement.requirement;
                            break;
                        case 'total_50':
                        case 'total_100':
                            achieved = totalCount >= achievement.requirement;
                            break;
                        case 'level_5':
                        case 'level_10':
                            achieved = this.playerLevel >= achievement.requirement;
                            break;
                        case 'perfect_day':
                            achieved = totalCount >= 10 && wrongCount === 0;
                            break;
                    }

                    if (achieved) {
                        this.unlockAchievement(achievement);
                    }
                });
            }

            // ÈÅîÊàêËß£Èô§
            unlockAchievement(achievement) {
                this.achievements.add(achievement.id);
                nekoponSound.playAchievement();
                this.showAchievement(achievement.name, achievement.description, achievement.icon);
                
                if ('vibrate' in navigator) {
                    navigator.vibrate([150, 80, 150, 80, 200]);
                }
            }

            // ÈÅîÊàê„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
            showAchievement(title, description, icon) {
                const popup = document.getElementById('achievementPopup');
                document.getElementById('achievementIcon').textContent = icon;
                document.getElementById('achievementTitle').textContent = title;
                document.getElementById('achievementDescription').textContent = description;
                
                popup.classList.add('show');
                
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 3000);
            }

            // „É¨„Éô„É´„Éê„ÉÉ„Ç∏Êõ¥Êñ∞
            updateLevelBadges() {
                const container = document.getElementById('levelBadges');
                container.innerHTML = '';
                
                for (let i = 1; i <= this.playerLevel; i++) {
                    const badge = document.createElement('span');
                    badge.className = 'level-badge';
                    badge.textContent = `Lv.${i}`;
                    badge.onclick = () => {
                        nekoponSound.playClick();
                        this.showFloatingMessage('„É¨„Éô„É´' + i + '„Éê„ÉÉ„Ç∏‚ô™', 'normal');
                    };
                    container.appendChild(badge);
                }
            }

            // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏
            showFloatingMessage(text, type = 'normal') {
                const msg = document.createElement('div');
                msg.className = `floating-score ${type}`;
                msg.textContent = text;
                msg.style.left = Math.random() * (window.innerWidth - 200) + 100 + 'px';
                msg.style.top = Math.random() * (window.innerHeight - 200) + 100 + 'px';
                document.body.appendChild(msg);
                
                setTimeout(() => msg.remove(), type === 'perfect' ? 4000 : (type === 'combo' ? 3500 : 3000));
            }

            // „Ç≥„É≥„Éú„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            createComboParticles() {
                const particles = ['‚ú®', 'üåü', 'üí´', '‚≠ê', 'üéâ', 'üéä'];
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        createParticle(
                            particles[Math.floor(Math.random() * particles.length)],
                            '#FFD700',
                            centerX + (Math.random() - 0.5) * 200,
                            centerY + (Math.random() - 0.5) * 200
                        );
                    }, i * 100);
                }
            }

            // Ë°®Á§∫Êõ¥Êñ∞
            updateDisplay() {
                document.getElementById('comboCount').textContent = this.comboCount;
                document.getElementById('comboCount').classList.add('pulse');
                setTimeout(() => {
                    document.getElementById('comboCount').classList.remove('pulse');
                }, 600);
            }

            // „É™„Çª„ÉÉ„Éà
            reset() {
                this.comboCount = 0;
                this.perfectStreak = 0;
                this.exitFeverMode();
                this.updateDisplay();
            }
        }

        const gameification = new NekoponGameification();

        /* ----------------- „Ç´„ÉÜ„Ç¥„É™„ÉºÂÆöÁæ©ÔºàÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„Åã„ÇâÔºâ ----------------- */
        const categories = {
            geography: [
                {id: 'geo_world_overview', name: '1.‰∏ñÁïå„ÅÆÂßø'},
                {id: 'geo_japan_overview', name: '2.Êó•Êú¨„ÅÆÂßø'},
                {id: 'geo_world_life', name: '3.‰∏ñÁïåÂêÑÂú∞„ÅÆ‰∫∫„ÄÖ„ÅÆÁîüÊ¥ª„Å®Áí∞Â¢É'},
                {id: 'geo_asia', name: '4.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç¢„Ç∏„Ç¢Â∑û'},
                {id: 'geo_europe', name: '5.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„É®„Éº„É≠„ÉÉ„ÉëÂ∑û'},
                {id: 'geo_africa', name: '6.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç¢„Éï„É™„Ç´Â∑û'},
                {id: 'geo_north_america', name: '7.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄÂåó„Ç¢„É°„É™„Ç´Â∑û'},
                {id: 'geo_south_america', name: '8.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄÂçó„Ç¢„É°„É™„Ç´Â∑û'},
                {id: 'geo_oceania', name: '9.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç™„Çª„Ç¢„Éã„Ç¢'},
                {id: 'geo_japan_features', name: '10.Êó•Êú¨„ÅÆÂú∞ÂüüÁöÑÁâπËâ≤'},
                {id: 'geo_japan_kyushu', name: '11.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄ‰πùÂ∑ûÂú∞Êñπ'},
                {id: 'geo_japan_chugoku', name: '12.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄ‰∏≠ÂõΩ„ÉªÂõõÂõΩÂú∞Êñπ'},
                {id: 'geo_japan_kinki', name: '13.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄËøëÁïøÂú∞Êñπ'},
                {id: 'geo_japan_chubu', name: '14.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄ‰∏≠ÈÉ®Âú∞Êñπ'},
                {id: 'geo_japan_kanto', name: '15.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄÈñ¢Êù±Âú∞Êñπ'},
                {id: 'geo_japan_tohoku', name: '16.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄÊù±ÂåóÂú∞Êñπ'},
                {id: 'geo_japan_hokkaido', name: '17.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄÂåóÊµ∑ÈÅìÂú∞Êñπ'}
            ],
            history: [
                {id: 'hist_ancient', name: '1.ÊñáÊòé„ÅÆ„Åä„Åì„Çä„Å®Êó•Êú¨„ÅÆÊàê„ÇäÁ´ã„Å°'},
                {id: 'hist_ancient_state', name: '2.Âè§‰ª£ÂõΩÂÆ∂„ÅÆÊ≠©„Åø„Å®Êù±„Ç¢„Ç∏„Ç¢'},
                {id: 'hist_kamakura', name: '3.Ê≠¶Â£´„ÅÆ„Åä„Åì„Çä„Å®ÈéåÂÄâÂπïÂ∫ú'},
                {id: 'hist_muromachi', name: '4.„É¢„É≥„Ç¥„É´„ÅÆË•≤Êù•„Å®ÂÆ§Áî∫ÂπïÂ∫ú'},
                {id: 'hist_unification', name: '5.„É®„Éº„É≠„ÉÉ„Éë‰∫∫„Å®„ÅÆÂá∫‰ºö„ÅÑ„Å®ÂÖ®ÂõΩÁµ±‰∏Ä'},
                {id: 'hist_edo_early', name: '6.Ê±üÊà∏ÂπïÂ∫ú„ÅÆÊàêÁ´ã„Å®ÈéñÂõΩ'},
                {id: 'hist_edo_develop', name: '7.Áî£Ê•≠„ÅÆÁô∫ÈÅî„Å®ÂπïÂ∫úÊîøÊ≤ª„ÅÆÂ±ïÈñã'},
                {id: 'hist_opening', name: '8.Ê¨ßÁ±≥„ÅÆÈÄ≤Âá∫„Å®Êó•Êú¨„ÅÆÈñãÂõΩ'},
                {id: 'hist_meiji', name: '9.ÊòéÊ≤ªÁ∂≠Êñ∞'},
                {id: 'hist_wars', name: '10.Êó•Ê∏Ö„ÉªÊó•Èú≤Êà¶‰∫â„Å®Êó•Êú¨„ÅÆÁî£Ê•≠Èù©ÂëΩ'},
                {id: 'hist_wwi', name: '11.Á¨¨‰∏ÄÊ¨°‰∏ñÁïåÂ§ßÊà¶„Å®Êó•Êú¨'},
                {id: 'hist_wwii', name: '12.‰∏ñÁïåÊÅêÊÖå„Å®Á¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊà¶'},
                {id: 'hist_postwar', name: '13.Êà¶Âæå„ÅÆÊó•Êú¨„ÅÆÁô∫Â±ï„Å®ÂõΩÈöõÁ§æ‰ºö'}
            ],
            civics: [
                {id: 'civics_modern', name: '1.Áèæ‰ª£Á§æ‰ºö„Å®ÁßÅ„Åü„Å°'},
                {id: 'civics_constitution', name: '2.‰∫∫Èñì„ÅÆÂ∞äÈáç„Å®Êó•Êú¨ÂõΩÊÜ≤Ê≥ï'},
                {id: 'civics_democracy', name: '3.Áèæ‰ª£„ÅÆÊ∞ë‰∏ªÊîøÊ≤ª'},
                {id: 'civics_economy', name: '4.ÊöÆ„Çâ„Åó„Å®ÁµåÊ∏à'}
            ],
            chemistry: [
                {id: 'chemistry_basic', name: '1.Áâ©Ë≥™„Å®„Åù„ÅÆÊÄßË≥™'},
                {id: 'chemistry_gas', name: '2.Ê∞ó‰Ωì„ÅÆÊÄßË≥™'},
                {id: 'chemistry_solution', name: '3.Ê∞¥Ê∫∂Ê∂≤„ÅÆÊÄßË≥™'},
                {id: 'chemistry_state', name: '4.Áä∂ÊÖãÂ§âÂåñ'},
                {id: 'chemistry_change', name: '5.Áâ©Ë≥™„ÅÆÂ§âÂåñ'},
                {id: 'chemistry_structure', name: '6.Áâ©Ë≥™„ÅÆÊàê„ÇäÁ´ã„Å°'},
                {id: 'chemistry_reaction', name: '7.Áâ©Ë≥™„Å©„ÅÜ„Åó„ÅÆÂåñÂ≠¶Â§âÂåñ'},
                {id: 'chemistry_mass', name: '8.ÂåñÂ≠¶Â§âÂåñ„Å®Ë≥™Èáè'},
                {id: 'chemistry_ion', name: '9.„Ç§„Ç™„É≥„Å®ÈõªÊ±†'},
                {id: 'chemistry_acid', name: '10.ÈÖ∏„ÄÅ„Ç¢„É´„Ç´„É™„ÄÅÂ°©'}
            ],
            biology: [
                {id: 'biology_flower', name: '1.Ëä±„ÅÆ„Å§„Åè„Çä'},
                {id: 'biology_plant', name: '2.Ê†π„ÉªËëâ„ÅÆ„Å§„Åè„Çä„ÄÅÊ§çÁâ©„ÅÆÁâπÂæ¥„Å®ÂàÜÈ°û'},
                {id: 'biology_animal', name: '3.ÂãïÁâ©„ÅÆÁâπÂæ¥„Å®ÂàÜÈ°û'},
                {id: 'biology_microscope', name: '4.È°ïÂæÆÈè°„ÅÆ‰Ωø„ÅÑÊñπ'},
                {id: 'biology_cell', name: '5.ÁîüÁâ©„Å®Á¥∞ËÉû'},
                {id: 'biology_plant_body', name: '6.Ê§çÁâ©„ÅÆ„Åã„Çâ„Å†„ÅÆ„Å§„Åè„Çä„ÄÅÊ§çÁâ©„Å®Êó•ÂÖâ'},
                {id: 'biology_digestion', name: '7.Ê∂àÂåñ„Å®Âê∏Âèé'},
                {id: 'biology_breathing', name: '8.ÂëºÂê∏'},
                {id: 'biology_circulation', name: '9.Ë°ÄÊ∂≤„ÅÆÂæ™Áí∞„ÄÅÊéíÂá∫„ÅÆ„Åó„Åè„Åø'},
                {id: 'biology_response', name: '10.Âà∫ÊøÄ„Å®ÂèçÂøú„ÄÅÂãïÁâ©„ÅÆ„Åã„Çâ„Å†'},
                {id: 'biology_growth', name: '11.ÁîüÁâ©„ÅÆÊàêÈï∑„Å®Á¥∞ËÉû„ÅÆÂ§âÂåñ'},
                {id: 'biology_reproduction', name: '12.ÁîüÁâ©„ÅÆÁîüÊÆñ'},
                {id: 'biology_heredity', name: '13.ÈÅ∫‰ºù„ÅÆË¶èÂâáÊÄß„Å®ÈÅ∫‰ºùÂ≠ê'},
                {id: 'biology_evolution', name: '14.ÁîüÁâ©„ÅÆÈÄ≤Âåñ„ÄÅÁîüÊÖãÁ≥ª„Å®È£üÁâ©ÈÄ£Èéñ'},
                {id: 'biology_environment', name: '15.Ëá™ÁÑ∂„Å®Áí∞Â¢É„ÄÅ‰∫∫Èñì„Å®Ëá™ÁÑ∂Áí∞Â¢É'}
            ],
            physics: [
                {id: 'physics_light', name: '1.ÂÖâ„Å´„Çà„ÇãÁèæË±°'},
                {id: 'physics_sound', name: '2.Èü≥„Å´„Çà„ÇãÁèæË±°'},
                {id: 'physics_force', name: '3.Âäõ„Å´„Çà„ÇãÁèæË±°'},
                {id: 'physics_current', name: '4.ÈõªÊµÅ„Å®ÈõªÂúß'},
                {id: 'physics_energy', name: '5.ÈõªÊ∞ó„Ç®„Éç„É´„ÇÆ„Éº'},
                {id: 'physics_magnetic', name: '6.ÈõªÊµÅ„Å®Á£ÅÁïå'},
                {id: 'physics_balance', name: '7.Âäõ„ÅÆ„Å§„ÇäÂêà„ÅÑ„Å®ÂêàÊàê„ÉªÂàÜËß£'},
                {id: 'physics_motion', name: '8.Áâ©‰Ωì„ÅÆÈÅãÂãï'},
                {id: 'physics_pressure', name: '9.Ê∞¥Âúß„Å®ÊµÆÂäõ'},
                {id: 'physics_work', name: '10.„Ç®„Éç„É´„ÇÆ„Éº„Å®‰ªï‰∫ã'},
                {id: 'physics_energy_change', name: '11.„Ç®„Éç„É´„ÇÆ„Éº„ÅÆÁßª„ÇäÂ§â„Çè„Çä'},
                {id: 'physics_resources', name: '12.„Ç®„Éç„É´„ÇÆ„ÉºË≥áÊ∫ê„ÅÆÂà©Áî®'}
            ],
            earth: [
                {id: 'earth_volcano', name: '1.ÁÅ´Â±±'},
                {id: 'earth_earthquake', name: '2.Âú∞Èúá'},
                {id: 'earth_strata', name: '3.Âú∞Â±§„ÅÆ„Åß„ÅçÊñπ'},
                {id: 'earth_weather', name: '4.Ê∞óË±°„ÅÆË¶≥Ê∏¨„ÄÅÂ§ßÊ∞óÂúß„Å®ÂúßÂäõ'},
                {id: 'earth_front', name: '5.Ê∞óÂõ£„Å®ÂâçÁ∑ö„ÄÅÊó•Êú¨„ÅÆÂ§©Ê∞ó'},
                {id: 'earth_cloud', name: '6.Èõ≤„ÅÆ„Åß„ÅçÊñπ„Å®Ê∞¥Ëí∏Ê∞ó'},
                {id: 'earth_celestial', name: '7.Âú∞ÁêÉ„ÅÆÂãï„Åç„Å®Â§©‰Ωì„ÅÆÂãï„Åç'},
                {id: 'earth_solar', name: '8.Â§™ÈôΩÁ≥ª„ÅÆÂ§©‰Ωì'},
                {id: 'earth_moon', name: '9.Êúà„Å®ÊÉëÊòü„ÅÆË¶ã„ÅàÊñπ„ÄÅËá™ÁÑ∂„ÅÆÊÅµ„Åø„Å®ÁÅΩÂÆ≥'}
            ],
            english_words: [
                {id: 'words_time', name: 'Êúà„ÉªÂ∫èÊï∞'},
                {id: 'words_week', name: 'ÊõúÊó•'},
                {id: 'words_timeday', name: 'ÊôÇ„ÉªÊôÇÈñìÂ∏Ø„Å™„Å©'},
                {id: 'words_season', name: 'Â≠£ÁØÄ„ÉªÂÆ∂Êóè'},
                {id: 'words_sports', name: '„Çπ„Éù„Éº„ÉÑ„ÉªÊïôÁßë'},
                {id: 'words_job', name: 'ËÅ∑Ê•≠„Éª‰∫∫„ÉªÂª∫Áâ©„ÉªÊñΩË®≠'},
                {id: 'words_uncountable', name: 'Êï∞„Åà„Çâ„Çå„Å™„ÅÑÂêçË©û'},
                {id: 'words_verb_important', name: 'ÂÖ•Ë©¶ÂøÖÂá∫ÈáçË¶ÅÂãïË©û'},
                {id: 'words_verb_various', name: '„ÅÑ„Çç„ÅÑ„Çç„Å™ÊÑèÂë≥„Çí„ÇÇ„Å§ÂãïË©û'},
                {id: 'words_verb_set', name: '„Çª„ÉÉ„Éà„ÅßË¶ö„Åà„Å¶„Åä„Åç„Åü„ÅÑÂãïË©û'},
                {id: 'words_verb_other', name: '„Åù„ÅÆ‰ªñ„ÅÆÈáçË¶ÅÂãïË©û'},
                {id: 'words_adj_quantity', name: 'Êï∞„ÉªÈáè„ÇíË°®„ÅôÂΩ¢ÂÆπË©û'},
                {id: 'words_adj_various', name: '„ÅÑ„Çç„ÅÑ„Çç„Å™ÂΩ¢ÂÆπË©û'},
                {id: 'words_adj_adv', name: '„Åù„ÅÆ‰ªñ„ÅÆÈáçË¶ÅÂΩ¢ÂÆπË©û„ÉªÂâØË©û'},
                {id: 'words_adv_manner', name: 'ÊßòÂ≠ê„ÇíË°®„ÅôÂâØË©û'}
            ],
            english_phrases: [
                {id: 'phrases_verb', name: '„Çà„ÅèÂá∫„ÇãÂãïË©û„ÅÆÁÜüË™û'},
                {id: 'phrases_set', name: '„Çª„ÉÉ„Éà„ÅßË¶ö„Åà„Å¶„Åä„Åç„Åü„ÅÑÁÜüË™û'},
                {id: 'phrases_similar', name: 'ÊÑèÂë≥„ÅÆ‰ºº„Å¶„ÅÑ„ÇãÁÜüË™û'},
                {id: 'phrases_verb_other', name: '„Åù„ÅÆ‰ªñ„ÅÆÂãïË©û„ÅÆÁÜüË™û'},
                {id: 'phrases_be', name: 'be ÂãïË©û„Çí‰Ωø„Å£„ÅüÁÜüË™û'},
                {id: 'phrases_quantity', name: 'Êï∞„ÇÑÈáè„ÇíË°®„ÅôÁÜüË™û'},
                {id: 'phrases_time_place', name: 'ÊôÇ„ÉªÂ†¥ÊâÄ„ÇíË°®„ÅôÁÜüË™û'},
                {id: 'phrases_important', name: '„Åù„ÅÆ‰ªñ„ÅÆÈáçË¶ÅÁÜüË™û'}
            ],
            english_grammar: [
                {id: 'grammar_irregular_past', name: '‰∏çË¶èÂâáÂãïË©û - ÈÅéÂéªÂΩ¢„ÉªÈÅéÂéªÂàÜË©û'},
                {id: 'grammar_irregular_same', name: '‰∏çË¶èÂâáÂãïË©û - ÈÅéÂéªÂΩ¢„Å®ÈÅéÂéªÂàÜË©û„ÅåÂêå„Åò'},
                {id: 'grammar_irregular_special', name: '‰∏çË¶èÂâáÂãïË©û - ÁâπÊÆä„Å™„Ç±„Éº„Çπ'},
                {id: 'grammar_be_past', name: 'be ÂãïË©û - ÈÅéÂéªÂΩ¢„ÉªÈÅéÂéªÂàÜË©û'},
                {id: 'grammar_regular', name: 'Ë¶èÂâáÂãïË©û - ÈÅéÂéªÂΩ¢„ÉªÈÅéÂéªÂàÜË©û'},
                {id: 'grammar_third_person', name: '‰∏â‰∫∫Áß∞ÂçòÊï∞ÁèæÂú®ÂΩ¢'},
                {id: 'grammar_ing', name: 'ÂãïË©û„ÅÆ -ing ÂΩ¢'},
                {id: 'grammar_comparative', name: 'ÂΩ¢ÂÆπË©û - ÊØîËºÉÁ¥ö„ÉªÊúÄ‰∏äÁ¥ö'},
                {id: 'grammar_more_most', name: 'more„ÄÅmost „Çí„Å§„Åë„ÇãÂΩ¢ÂÆπË©û'},
                {id: 'grammar_noun_plural', name: 'ÂêçË©û„ÅÆË§áÊï∞ÂΩ¢'},
                {id: 'grammar_irregular_plural', name: '‰∏çË¶èÂâá„Å™Ë§áÊï∞ÂΩ¢'},
                {id: 'grammar_pronoun', name: '‰∫∫Áß∞‰ª£ÂêçË©û'}
            ]
        };

        /* ----------------- „Ç≤„Éº„É†Â§âÊï∞ ----------------- */
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalCount = 0;
        let usedQuestions = [];
        let particleOffset = 0;
        let currentSubject = '';
        let questionMode = 'random';
        let sequentialIndex = 0;

        /* ----------------- „Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞ ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            document.body.appendChild(particle);

            particleOffset += 40;
            if (particleOffset > 160) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2500);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3500);
        }

        function showMsg(text, x, y) {
            const el = document.createElement('div');
            el.className = 'msg';
            el.textContent = text;
            el.style.left = Math.min(x, window.innerWidth - 120) + 'px';
            el.style.top = Math.min(y, window.innerHeight - 50) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        /* ----------------- ÁîªÈù¢ÈÅ∑ÁßªÈñ¢Êï∞ ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainSubjectModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToSocial() {
            hideAllModals();
            document.getElementById('socialModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToScience() {
            hideAllModals();
            document.getElementById('scienceModal').classList.add('show');
            nekoponSound.playClick();
        }

        function goBackToEnglish() {
            hideAllModals();
            document.getElementById('englishModal').classList.add('show');
            nekoponSound.playClick();
        }

        function closeAchievement() {
            document.getElementById('achievementPopup').classList.remove('show');
            nekoponSound.playClick();
        }

        /* ----------------- „Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû„ÅÆÂàùÊúüÂåñ ----------------- */
        function initCategorySelection() {
            // Âú∞ÁêÜ„Ç´„ÉÜ„Ç¥„É™„Éº
            const geographyContainer = document.getElementById('geographyCategories');
            categories.geography.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('geography', category.id, btn);
                geographyContainer.appendChild(btn);
            });

            // Ê≠¥Âè≤„Ç´„ÉÜ„Ç¥„É™„Éº
            const historyContainer = document.getElementById('historyCategories');
            categories.history.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('history', category.id, btn);
                historyContainer.appendChild(btn);
            });

            // ÂÖ¨Ê∞ë„Ç´„ÉÜ„Ç¥„É™„Éº
            const civicsContainer = document.getElementById('civicsCategories');
            categories.civics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('civics', category.id, btn);
                civicsContainer.appendChild(btn);
            });

            // ÂåñÂ≠¶„Ç´„ÉÜ„Ç¥„É™„Éº
            const chemistryContainer = document.getElementById('chemistryCategories');
            categories.chemistry.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
                chemistryContainer.appendChild(btn);
            });

            // ÁîüÁâ©„Ç´„ÉÜ„Ç¥„É™„Éº
            const biologyContainer = document.getElementById('biologyCategories');
            categories.biology.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                biologyContainer.appendChild(btn);
            });

            // Áâ©ÁêÜ„Ç´„ÉÜ„Ç¥„É™„Éº
            const physicsContainer = document.getElementById('physicsCategories');
            categories.physics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                physicsContainer.appendChild(btn);
            });

            // Âú∞Â≠¶„Ç´„ÉÜ„Ç¥„É™„Éº
            const earthContainer = document.getElementById('earthCategories');
            categories.earth.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                earthContainer.appendChild(btn);
            });

            // Ëã±ÂçòË™û„Ç´„ÉÜ„Ç¥„É™„Éº
            const englishWordsContainer = document.getElementById('englishWordsCategories');
            categories.english_words.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_words', category.id, btn);
                englishWordsContainer.appendChild(btn);
            });

            // Ëã±ÁÜüË™û„Ç´„ÉÜ„Ç¥„É™„Éº
            const englishPhrasesContainer = document.getElementById('englishPhrasesCategories');
            categories.english_phrases.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_phrases', category.id, btn);
                englishPhrasesContainer.appendChild(btn);
            });

            // Ë™ûÂΩ¢Â§âÂåñ„Ç´„ÉÜ„Ç¥„É™„Éº
            const englishGrammarContainer = document.getElementById('englishGrammarCategories');
            categories.english_grammar.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_grammar', category.id, btn);
                englishGrammarContainer.appendChild(btn);
            });
        }

        function toggleCategorySelection(subject, categoryId, buttonElement) {
            nekoponSound.playClick();
            if (selectedCategories.includes(categoryId)) {
                selectedCategories = selectedCategories.filter(id => id !== categoryId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(categoryId);
                buttonElement.classList.add('active');
            }

            // „ÇØ„Ç§„Ç∫ÈñãÂßã„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            const camelCase = subject.split('_')
                .map((word, index) => index === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
            const startButton = document.getElementById(`start${camelCase}Quiz`);

            if (startButton) {
                startButton.disabled = selectedCategories.length === 0;
            }
        }

        function startSelectedQuiz(subject, subjectName) {
            currentSubject = subject;
            hideAllModals();
            document.getElementById('currentCategory').textContent = `${subjectName} - ${selectedCategories.length}ÂçòÂÖÉÈÅ∏Êäû`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // Áµ±Ë®à„Çí„É™„Çª„ÉÉ„Éà
            correctCount = 0;
            wrongCount = 0;
            totalCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            gameification.reset();
            updateStats();
            showNotification(`${subjectName}„ÅÆ${selectedCategories.length}ÂçòÂÖÉ„ÇíÈÅ∏Êäû„Åó„Åü„Å´„ÇÉ„ÄúÔºÅ`);
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'ÂïèÈ°å„Çí„É©„É≥„ÉÄ„É†„Å´Âá∫È°å„Åó„Åæ„Åô';
                usedQuestions = [];
                showNotification('üé≤ „É©„É≥„ÉÄ„É†Âá∫È°å„Å´Âàá„ÇäÊõø„Åà„Åü„Å´„ÇÉ„Äú');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'ÂïèÈ°å„ÇíÈ†ÜÁï™ÈÄö„Çä„Å´Âá∫È°å„Åó„Åæ„Åô';
                sequentialIndex = 0;
                showNotification('üìã È†ÜÁï™ÈÄö„ÇäÂá∫È°å„Å´Âàá„ÇäÊõø„Åà„Åü„Å´„ÇÉ„Äú');
            }
        }

        /* ----------------- „ÇØ„Ç§„Ç∫Ê©üËÉΩ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('ÂçòÂÖÉ„ÇíÈÅ∏Êäû„Åó„Å¶„Å´„ÇÉ„Äú');
                return;
            }

            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) {
                showNotification('ÈÅ∏Êäû„Åï„Çå„ÅüÂçòÂÖÉ„ÅÆÂïèÈ°å„ÅØ„Åæ„Å†Ê∫ñÂÇô‰∏≠„Å´„ÇÉ„Äú');
                return;
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('üéâ ÂÖ®Âïè„ÇØ„É™„Ç¢ÔºÅÂïèÈ°å„Çí„É™„Çª„ÉÉ„Éà„Åó„Åü„Å´„ÇÉ„Äú');
            }

            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('üîÑ ÂÖ®ÂïèÈ°å„Çí‰∏ÄÂë®„Åó„Åü„Å´„ÇÉ„ÄúÔºÅÊúÄÂàù„Åã„ÇâÂÜçÈñã„Åó„Åæ„Åô‚ô™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (ÊÆã„Çä${remainingCount}Âïè)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<span>${txt}</span>`;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        
                        if (i === quiz.ans) {
                            correctCount++;
                            gameification.onCorrectAnswer();
                            nekoponSound.playCorrect();
                            showNotification('Ê≠£Ëß£„Å´„ÇÉ„ÄúÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„Å´„ÇÉ‚ô™');
                            createParticle('‚ú® Ê≠£Ëß£ÔºÅ', '#FFD700', window.innerWidth / 2, window.innerHeight / 2);
                            
                            // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥
                            if ('vibrate' in navigator) {
                                navigator.vibrate([100, 50, 100]);
                            }
                        } else {
                            wrongCount++;
                            gameification.onWrongAnswer();
                            nekoponSound.playWrong();
                            
                            // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥
                            if ('vibrate' in navigator) {
                                navigator.vibrate([200]);
                            }
                        }
                        updateStats();
                        
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `üéâ Ê≠£Ëß£„Å´„ÇÉ„ÄúÔºÅ${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `‚ùå ÊÆãÂøµ...‰∏çÊ≠£Ëß£„Å´„ÇÉ„ÄÇÊ≠£Ëß£„ÅØ„Äå${quiz.opts[quiz.ans]}„Äç„Å†„Å´„ÇÉ„ÄÇ${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });

            nextBtn.onclick = () => {
                nekoponSound.playClick();
                loadNextQuiz();
            };

            backBtn.onclick = () => {
                nekoponSound.playClick();
                modal.classList.remove('show');
                showNotification('„ÅäÁñ≤„ÇåÊßò„Åß„Åó„Åü„Å´„ÇÉ„ÄúÔºÅ');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) return;

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('üéâ ÂÖ®Âïè„ÇØ„É™„Ç¢ÔºÅÂïèÈ°å„Çí„É™„Çª„ÉÉ„Éà„Åó„Åü„Å´„ÇÉ„Äú');
            }

            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('üîÑ ÂÖ®ÂïèÈ°å„Çí‰∏ÄÂë®„Åó„Åü„Å´„ÇÉ„ÄúÔºÅÊúÄÂàù„Åã„ÇâÂÜçÈñã„Åó„Åæ„Åô‚ô™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (ÊÆã„Çä${remainingCount}Âïè)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<span>${txt}</span>`;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        if (i === quiz.ans) {
                            correctCount++;
                            gameification.onCorrectAnswer();
                            nekoponSound.playCorrect();
                            showNotification('Ê≠£Ëß£„Å´„ÇÉ„ÄúÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„Å´„ÇÉ‚ô™');
                            createParticle('‚ú® Ê≠£Ëß£ÔºÅ', '#FFD700', window.innerWidth / 2, window.innerHeight / 2);
                            
                            if ('vibrate' in navigator) {
                                navigator.vibrate([100, 50, 100]);
                            }
                        } else {
                            wrongCount++;
                            gameification.onWrongAnswer();
                            nekoponSound.playWrong();
                            
                            if ('vibrate' in navigator) {
                                navigator.vibrate([200]);
                            }
                        }
                        updateStats();
                        
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `üéâ Ê≠£Ëß£„Å´„ÇÉ„ÄúÔºÅ${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `‚ùå ÊÆãÂøµ...‰∏çÊ≠£Ëß£„Å´„ÇÉ„ÄÇÊ≠£Ëß£„ÅØ„Äå${quiz.opts[quiz.ans]}„Äç„Å†„Å´„ÇÉ„ÄÇ${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });
        }

        /* ----------------- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ----------------- */
        function initEventListeners() {
            // „Çø„Ç§„Éà„É´Ë¶ÅÁ¥†„ÅÆ„Çø„ÉÉ„Éó
            document.getElementById('mainTitle').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playTitleBounce();
                document.getElementById('mainTitle').classList.add('title-bounce');
                gameification.showFloatingMessage('NEKOPON Quiz‚ô™', 'normal');
                
                setTimeout(() => {
                    document.getElementById('mainTitle').classList.remove('title-bounce');
                }, 1500);
                
                if ('vibrate' in navigator) {
                    navigator.vibrate([150, 100, 150]);
                }
            });

            // Áå´„Ç¢„Ç§„Ç≥„É≥„Çø„ÉÉ„Éó
            document.getElementById('leftCat').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playCatBounce();
                document.getElementById('leftCat').classList.add('bounce');
                gameification.showFloatingMessage('„Å´„ÇÉ„Äú„Çì‚ô™', 'normal');
                
                setTimeout(() => {
                    document.getElementById('leftCat').classList.remove('bounce');
                }, 1000);
            });

            document.getElementById('rightCat').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playCatBounce();
                document.getElementById('rightCat').classList.add('bounce');
                gameification.showFloatingMessage('„Åø„ÇÉ„Äú„ÅÜ‚ô™', 'normal');
                
                setTimeout(() => {
                    document.getElementById('rightCat').classList.remove('bounce');
                }, 1000);
            });

            // ËÇâÁêÉ„Çø„ÉÉ„Éó
            document.getElementById('leftPaw').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playPawTap();
                document.getElementById('leftPaw').classList.add('tap-effect');
                gameification.showFloatingMessage('„Å∑„Å´„Å∑„Å´‚ô™', 'normal');
                
                setTimeout(() => {
                    document.getElementById('leftPaw').classList.remove('tap-effect');
                }, 800);
            });

            document.getElementById('rightPaw').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playPawTap();
                document.getElementById('rightPaw').classList.add('tap-effect');
                gameification.showFloatingMessage('„ÇÇ„Å°„ÇÇ„Å°‚ô™', 'normal');
                
                setTimeout(() => {
                    document.getElementById('rightPaw').classList.remove('tap-effect');
                }, 800);
            });

            // „Çπ„Ç≥„Ç¢È†ÖÁõÆ„Çø„ÉÉ„Éó
            document.getElementById('correctCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                gameification.showFloatingMessage('Ê≠£Ëß£Êï∞„Å†„Å´„ÇÉ„Äú‚ô™', 'normal');
            });

            document.getElementById('wrongCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                gameification.showFloatingMessage('„Åæ„Å°„Åå„ÅÑ„ÇÇÂãâÂº∑„Å´„ÇÉ„Äú', 'normal');
            });

            document.getElementById('totalCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                gameification.showFloatingMessage('È†ëÂºµ„Å£„Å¶„Çã„Å´„ÇÉ„ÄúÔºÅ', 'normal');
            });

            document.getElementById('comboCount').addEventListener('click', (e) => {
                e.stopPropagation();
                nekoponSound.playClick();
                gameification.showFloatingMessage('ÈÄ£Á∂öÊ≠£Ëß£„Åô„Åî„ÅÑ„Å´„ÇÉ„ÄúÔºÅ', 'normal');
            });

            // „É°„Ç§„É≥ÊïôÁßëÈÅ∏Êäû
            document.querySelectorAll('[data-subject]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    nekoponSound.playClick();
                    const subject = e.currentTarget.dataset.subject;
                    hideAllModals();
                    document.getElementById(subject + 'Modal').classList.add('show');
                });
            });

            // Ë©≥Á¥∞„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    nekoponSound.playClick();
                    const category = e.currentTarget.dataset.category;
                    selectedCategories = [];
                    hideAllModals();
                    
                    const modalId = category.split('_')
                        .map((word, index) => index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1))
                        .join('');
                    
                    document.getElementById(modalId + 'Modal').classList.add('show');
                });
            });

            // „ÇØ„Ç§„Ç∫ÈñãÂßã„Éú„Çø„É≥Áæ§
            document.getElementById('startGeographyQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('geography', 'üó∫Ô∏è Âú∞ÁêÜ');
            });
            document.getElementById('startHistoryQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('history', 'üèõÔ∏è Ê≠¥Âè≤');
            });
            document.getElementById('startCivicsQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('civics', '‚öñÔ∏è ÂÖ¨Ê∞ë');
            });
            document.getElementById('startChemistryQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('chemistry', 'üß™ ÂåñÂ≠¶');
            });
            document.getElementById('startBiologyQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('biology', 'üß¨ ÁîüÁâ©');
            });
            document.getElementById('startPhysicsQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('physics', '‚öõÔ∏è Áâ©ÁêÜ');
            });
            document.getElementById('startEarthQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('earth', 'üåç Âú∞Â≠¶');
            });
            document.getElementById('startEnglishWordsQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('english_words', 'üìù Ëã±ÂçòË™û');
            });
            document.getElementById('startEnglishPhrasesQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('english_phrases', 'üí¨ Ëã±ÁÜüË™û');
            });
            document.getElementById('startEnglishGrammarQuiz').addEventListener('click', () => {
                nekoponSound.playPerfect();
                startSelectedQuiz('english_grammar', 'üìò Ë™ûÂΩ¢Â§âÂåñ');
            });

            // „É°„Ç§„É≥„ÇØ„Ç§„Ç∫„Çπ„Çø„Éº„Éà„Éú„Çø„É≥
            document.getElementById('startQuizButton').addEventListener('click', () => {
                nekoponSound.playPerfect();
                openQuiz();
            });

            // Âá∫È°åÂΩ¢ÂºèÂàá„ÇäÊõø„Åà„Éú„Çø„É≥
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                nekoponSound.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                nekoponSound.playClick();
                setQuestionMode('sequential');
            });

            // ÊïôÁßëÂ§âÊõ¥„Éú„Çø„É≥
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                nekoponSound.playClick();
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                gameification.reset();
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
                showNotification('ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Å£„Åü„Å´„ÇÉ„Äú');
            });

            // ÂÖ®„Éú„Çø„É≥„Å´ÂèØÊÑõ„ÅÑÂäπÊûúÈü≥„ÇíËøΩÂä†
            document.addEventListener('click', (e) => {
                if (e.target.matches('button:not([data-sound-added])') && !e.target.disabled) {
                    // ÁâπÂà•„Å™Èü≥„Åå„Å™„ÅÑ„Éú„Çø„É≥„Å´„ÅØÂü∫Êú¨„ÇØ„É™„ÉÉ„ÇØÈü≥
                    if (!e.target.classList.contains('quiz-option') && 
                        !e.target.classList.contains('clean-button') &&
                        !e.target.classList.contains('subject-btn') &&
                        !e.target.classList.contains('category-btn')) {
                        nekoponSound.playClick();
                    }
                    e.target.setAttribute('data-sound-added', 'true');
                }
            });
        }

        /* ----------------- Èö†„ÇåË¶ÅÁ¥†„ÅÆ„Çø„ÉÉ„ÉóÊ©üËÉΩ ----------------- */
        function initHiddenTapFeatures() {
            // ÂÖ®ÁîªÈù¢„ÅÆ„É©„É≥„ÉÄ„É†‰ΩçÁΩÆ„Çø„ÉÉ„Éó„Åß„Çµ„Éó„É©„Ç§„Ç∫
            let tapCount = 0;
            const surpriseMessages = [
                '„Å´„ÇÉÔºü', '„Åø„ÇÉ„ÅÜ‚ô™', '„Å∫„Çç„Å∫„Çç„Äú', '„ÇÇ„Åµ„ÇÇ„Åµ‚ô™', '„Å∑„Å´„Å∑„Å´„Äú',
                '„Åè„Çã„Åè„Çã„Äú', '„Åµ„Çè„Åµ„Çè‚ô™', '„Åç„Çâ„Åç„Çâ„Äú', '„Å¥„Çá„Çì„Å¥„Çá„Çì‚ô™', '„Å´„ÇÉ„Çì„Å´„ÇÉ„Çì‚ô™'
            ];

            document.body.addEventListener('click', (e) => {
                // UI„Ç®„É¨„É°„É≥„Éà‰ª•Â§ñ„ÅÆÂ†¥ÊâÄ„Çí„Çø„ÉÉ„Éó„Åó„ÅüÂ†¥Âêà
                if (e.target === document.body || e.target.classList.contains('modal')) {
                    tapCount++;
                    
                    if (tapCount % 7 === 0) { // 7„Çø„ÉÉ„Éó„Åî„Å®„Å´„Çµ„Éó„É©„Ç§„Ç∫
                        nekoponSound.playPawTap();
                        const message = surpriseMessages[Math.floor(Math.random() * surpriseMessages.length)];
                        gameification.showFloatingMessage(message, 'normal');
                        createParticle('üêæ', '#FF69B4', e.clientX, e.clientY);
                        
                        if ('vibrate' in navigator) {
                            navigator.vibrate([50, 30, 50]);
                        }
                    }
                }
            });

            // Èï∑Êäº„Åó„Åß„Çπ„Éö„Ç∑„É£„É´„Ç®„Éï„Çß„ÇØ„Éà
            let longPressTimer;
            let isLongPress = false;

            document.addEventListener('touchstart', (e) => {
                isLongPress = false;
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    // Èï∑Êäº„Åó„Çπ„Éö„Ç∑„É£„É´„Ç®„Éï„Çß„ÇØ„Éà
                    nekoponSound.playPerfect();
                    gameification.showFloatingMessage('„Å™„Åå„Åä„Åó‚ô™ „Åô„Å∫„Åó„ÇÉ„Çã„ÄúÔºÅ', 'perfect');
                    
                    // ÁîªÈù¢ÂÖ®‰Ωì„Å´„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            createParticle(
                                ['üåü', '‚ú®', 'üí´', 'üéâ', 'üéä', 'üíñ'][Math.floor(Math.random() * 6)],
                                ['#FFD700', '#FF69B4', '#00CED1', '#FF7F50'][Math.floor(Math.random() * 4)],
                                Math.random() * window.innerWidth,
                                Math.random() * window.innerHeight
                            );
                        }, i * 100);
                    }
                    
                    if ('vibrate' in navigator) {
                        navigator.vibrate([100, 50, 100, 50, 200]);
                    }
                }, 1000);
            });

            document.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });

            document.addEventListener('touchmove', () => {
                clearTimeout(longPressTimer);
            });
        }

        /* ----------------- „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú„Å®„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ ----------------- */
        function initResponsiveFeatures() {
            // ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Åü„Ç®„Éï„Çß„ÇØ„ÉàË™øÊï¥
            function adjustEffectsForScreen() {
                const isMobile = window.innerWidth <= 640;
                const isTablet = window.innerWidth <= 1024 && window.innerWidth > 640;
                
                // „É¢„Éê„Ç§„É´„Åß„ÅØ‰∏ÄÈÉ®„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà„ÇíËªΩÈáèÂåñ
                if (isMobile) {
                    document.documentElement.style.setProperty('--animation-duration', '0.2s');
                } else {
                    document.documentElement.style.setProperty('--animation-duration', '0.3s');
                }
            }

            // ÂàùÊúüË®≠ÂÆö
            adjustEffectsForScreen();
            
            // „É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆË™øÊï¥
            window.addEventListener('resize', adjustEffectsForScreen);

            // „Éê„ÉÉ„ÉÜ„É™„ÉºÊÆãÈáè„Å´Âøú„Åò„Åü„Ç®„Éï„Çß„ÇØ„ÉàË™øÊï¥ÔºàÂØæÂøú„Éñ„É©„Ç¶„Ç∂„ÅÆ„ÅøÔºâ
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    if (battery.level < 0.2) {
                        // „Éê„ÉÉ„ÉÜ„É™„ÉºÊÆãÈáè„ÅåÂ∞ë„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç®„Éï„Çß„ÇØ„Éà„ÇíÊéß„Åà„ÇÅ„Å´
                        console.log('Battery saving mode enabled');
                    }
                });
            }
        }

        /* ----------------- Â≠¶Áøí„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø ----------------- */
        class NekoponProgress {
            constructor() {
                this.storageKey = 'nekopon-quiz-progress';
                this.loadProgress();
            }

            saveProgress() {
                const progressData = {
                    totalQuestions: totalCount,
                    correctAnswers: correctCount,
                    wrongAnswers: wrongCount,
                    playerLevel: gameification.playerLevel,
                    totalExperience: gameification.totalExperience,
                    maxCombo: gameification.maxCombo,
                    achievements: Array.from(gameification.achievements),
                    lastPlayed: new Date().toISOString(),
                    favoriteSubjects: this.getFavoriteSubjects()
                };

                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(progressData));
                } catch (e) {
                    console.log('Progress save failed:', e);
                }
            }

            loadProgress() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        const progressData = JSON.parse(saved);
                        
                        // „Ç≤„Éº„Éü„Éï„Ç£„Ç±„Éº„Ç∑„Éß„É≥ „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ
                        gameification.playerLevel = progressData.playerLevel || 1;
                        gameification.totalExperience = progressData.totalExperience || 0;
                        gameification.maxCombo = progressData.maxCombo || 0;
                        gameification.achievements = new Set(progressData.achievements || []);
                        
                        // „É¨„Éô„É´„Éê„ÉÉ„Ç∏„ÅÆÊõ¥Êñ∞
                        gameification.updateLevelBadges();
                        
                        // Âæ©Â∏∞„É°„ÉÉ„Çª„Éº„Ç∏
                        if (progressData.lastPlayed) {
                            const daysSinceLastPlay = Math.floor(
                                (new Date() - new Date(progressData.lastPlayed)) / (1000 * 60 * 60 * 24)
                            );
                            
                            if (daysSinceLastPlay === 0) {
                                showNotification('„Åä„Åã„Åà„Çä„Å´„ÇÉ„ÄúÔºÅ‰ªäÊó•„ÇÇÈ†ëÂºµ„Çç„ÅÜ‚ô™');
                            } else if (daysSinceLastPlay === 1) {
                                showNotification('Êò®Êó•„Å∂„Çä„Å´„ÇÉ„ÄúÔºÅÂæÖ„Å£„Å¶„Åü„Å´„ÇÉ‚ô™');
                            } else if (daysSinceLastPlay > 1) {
                                showNotification(`${daysSinceLastPlay}Êó•„Å∂„Çä„Å´„ÇÉ„ÄúÔºÅ‰ºö„Åà„Å¶Â¨â„Åó„ÅÑ„Å´„ÇÉ‚ô™`);
                            }
                        }
                    }
                } catch (e) {
                    console.log('Progress load failed:', e);
                }
            }

            getFavoriteSubjects() {
                // ‰ΩøÁî®È†ªÂ∫¶„ÅÆÈ´ò„ÅÑÊïôÁßë„ÇíË®òÈå≤ÔºàÂÆüË£Ö„ÅØÁ∞°Áï•ÂåñÔºâ
                return ['geography', 'english_words'];
            }

            // ÂÆöÊúü‰øùÂ≠ò
            startAutoSave() {
                setInterval(() => {
                    this.saveProgress();
                }, 30000); // 30Áßí„Åî„Å®„Å´Ëá™Âãï‰øùÂ≠ò
            }
        }

        const progressManager = new NekoponProgress();

        /* ----------------- ÂàùÊúüÂåñ„Å®„É°„Ç§„É≥Âá¶ÁêÜ ----------------- */
        document.addEventListener('DOMContentLoaded', () => {
            // „Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû„ÅÆÂàùÊúüÂåñ
            initCategorySelection();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÂàùÊúüÂåñ
            initEventListeners();
            
            // Èö†„ÇåÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
            initHiddenTapFeatures();
            
            // „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú„ÅÆÂàùÊúüÂåñ
            initResponsiveFeatures();
            
            // Ëá™Âãï‰øùÂ≠òÈñãÂßã
            progressManager.startAutoSave();
            
            // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã
            document.getElementById('changeSubject').classList.add('hidden');
            
            // „Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆÊúÄÈÅ©Âåñ
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.userSelect = 'none';

            // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñÔºà„É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ÂæåÔºâ
            document.addEventListener('click', () => {
                if (nekoponSound.audioContext && nekoponSound.audioContext.state === 'suspended') {
                    nekoponSound.audioContext.resume();
                }
            }, { once: true });

            // Èü≥Â£∞ÂêàÊàê„ÅÆÂàùÊúüÂåñ
            if ('speechSynthesis' in window && typeof speechSynthesis.getVoices === 'function') {
                const voicePolling = setInterval(() => {
                    if (speechSynthesis.getVoices().length) {
                        clearInterval(voicePolling);
                    } else {
                        speechSynthesis.getVoices(); 
                    }
                }, 200);
            }

            // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ‰øùÂ≠ò
            window.addEventListener('beforeunload', () => {
                progressManager.saveProgress();
            });

            // ÂàùÂõûËµ∑Âãï„ÅÆ„Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏
            setTimeout(() => {
                if (gameification.playerLevel === 1 && gameification.totalExperience === 0) {
                    gameification.showAchievement(
                        'NEKOPON Quiz„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ', 
                        'Ê•Ω„Åó„ÅèÂ≠¶Áøí„Åó„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ‚ô™',
                        'üéâ'
                    );
                }
            }, 1000);

            // ÂÆöÊúüÁöÑ„Å™ÂèØÊÑõ„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏Ôºà5ÂàÜ„Åî„Å®Ôºâ
            setInterval(() => {
                const encourageMessages = [
                    '„Åå„Çì„Å∞„Å£„Å¶„Çã„Å´„ÇÉ„Äú‚ô™',
                    '„Åô„Åî„ÅÑ„Å´„ÇÉ„ÄúÔºÅ',
                    '„Åà„Çâ„ÅÑ„Åà„Çâ„ÅÑ‚ô™',
                    '„ÇÇ„ÅÜÂ∞ë„Åó„Å´„ÇÉ„ÄúÔºÅ',
                    '„Å†„ÅÑ„Åô„Åç„Å´„ÇÉ„Äú‚ô™',
                    '„Åç„Çá„ÅÜ„ÇÇ„Åå„Çì„Å∞„Çç„ÅÜ‚ô™'
                ];
                
                if (document.getElementById('gameScreen').classList.contains('hidden') === false) {
                    const message = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                    gameification.showFloatingMessage(message, 'normal');
                }
            }, 300000); // 5ÂàÜ = 300,000ms
        });

        /* ----------------- ËøΩÂä†„ÅÆ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ----------------- */
        
        // „Çπ„Ç≥„Ç¢„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatScore(score) {
            if (score >= 1000000) return Math.floor(score / 1000000) + 'M';
            if (score >= 1000) return Math.floor(score / 1000) + 'K';
            return score.toString();
        }

        // ÊôÇÈñì„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // „Éá„Éê„ÉÉ„Ç∞Áî®Èñ¢Êï∞ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
        function debugInfo() {
            console.log('üêæ NEKOPON Quiz Debug Info üêæ');
            console.log('Player Level:', gameification.playerLevel);
            console.log('Total Experience:', gameification.totalExperience);
            console.log('Achievements:', Array.from(gameification.achievements));
            console.log('Combo Count:', gameification.comboCount);
            console.log('Fever Mode:', gameification.feverMode);
            console.log('Selected Categories:', selectedCategories);
            console.log('Question Mode:', questionMode);
        }

        // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
        window.nekoponDebug = debugInfo;
        window.nekoponGame = gameification;
        window.nekoponSound = nekoponSound;
        window.nekoponProgress = progressManager;
    </script>
</body>
</html>