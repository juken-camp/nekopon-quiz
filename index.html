<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ğŸ± NEKOPON Quiz ğŸ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-brown: #8b4513;
            --light-brown: #d2691e;
            --cream: #faf8f5;
            --white: #ffffff;
            --soft-orange: #ff7f50;
            --gold: #ffd700;
            --pink: #ffb6c1;
            --shadow: rgba(139,69,19,0.25);
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--cream);
            color: var(--primary-brown);
            font-weight: 700;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
        }

        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }

        @media (min-width: 640px) {
            .container-spacing {
                max-width: 500px;
            }
        }

        @media (min-width: 768px) {
            .container-spacing {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 700px;
            }
        }

        .game-title {
            font-family: 'Fredoka One', cursive;
            font-weight: 400;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--light-brown);
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 8px var(--shadow);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
            opacity: 0;
            animation: title-enter 1.5s ease-out 0.2s forwards;
        }

        .game-title:hover {
            transform: scale(1.05);
        }

        .game-title.title-bounce {
            animation: title-bounce 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes title-enter {
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.8); 
            }
            60% { 
                opacity: 1; 
                transform: translateY(5px) scale(1.1); 
            }
            80% { 
                transform: translateY(-2px) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes title-bounce {
            0% { transform: scale(1) rotate(0deg); }
            15% { transform: scale(1.1) rotate(2deg); }
            30% { transform: scale(1.18) rotate(-1deg); }
            45% { transform: scale(1.25) rotate(1deg); }
            60% { transform: scale(1.15) rotate(-0.5deg); }
            75% { transform: scale(1.08) rotate(0.5deg); }
            85% { transform: scale(1.03) rotate(-0.2deg); }
            95% { transform: scale(1.01) rotate(0.1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .cat-icon {
            display: inline-block;
            cursor: pointer;
            font-size: 42px;
            margin: 0 8px;
            transition: transform 0.1s ease-out;
            animation: cat-icon-sparkle 3s ease-in-out infinite;
        }

        .cat-icon:hover {
            transform: scale(1.2) rotate(15deg) !important;
        }

        .cat-icon.bounce {
            animation: cat-bounce 0.8s ease-in-out !important;
        }

        @keyframes cat-icon-sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(2deg); }
            50% { transform: scale(1.1) rotate(-1deg); }
            75% { transform: scale(1.05) rotate(1deg); }
        }

        @keyframes cat-bounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.4) rotate(15deg); }
            50% { transform: scale(1.6) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(12deg); }
        }

        .clean-card {
            background: var(--white);
            border: 2px solid var(--light-brown);
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--shadow);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .clean-button {
            background: var(--light-brown);
            border: none;
            color: white;
            font-weight: 700;
            border-radius: 25px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .clean-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow);
            background: var(--soft-orange);
        }

        .clean-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .clean-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .subject-btn, .category-btn {
            background: var(--white);
            border: 3px solid var(--light-brown);
            border-radius: 15px;
            color: var(--primary-brown);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
        }

        .subject-btn:hover, .category-btn:hover {
            border-color: var(--soft-orange);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 28px var(--shadow);
            background: #fff8f0;
        }

        .subject-btn.active, .category-btn.active {
            background: #ffe4cc;
            border-color: var(--soft-orange);
            color: var(--soft-orange);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 28px var(--shadow);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(139,69,19,0.4);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.5s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .floating-msg {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-brown);
            pointer-events: none;
            z-index: 800;
            animation: float-up 2.5s ease-out forwards;
            text-shadow: 1px 1px 4px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.3); }
        }

        .particle {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            z-index: 400;
            animation: particle-burst 2s ease-out forwards;
        }

        @keyframes particle-burst {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            20% { opacity: 1; transform: scale(1.5) rotate(180deg); }
            100% { opacity: 0; transform: scale(0.5) rotate(720deg) translateY(-100px); }
        }

        .quiz-option {
            background: var(--white);
            border: 3px solid var(--light-brown);
            color: var(--primary-brown);
            border-radius: 15px;
            padding: 0.75rem 1rem;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 700;
            font-size: 0.9rem;
            position: relative;
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .quiz-option:hover {
            border-color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow);
            background: #fff8f0;
        }

        .quiz-explanation {
            height: 150px;
            background: #fff8f0;
            border-radius: 15px;
            padding: 0.75rem;
            margin-top: 1rem;
            border: 3px solid var(--light-brown);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .quiz-explanation p {
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            max-height: 100%;
            overflow: hidden;
            font-size: 1rem;
        }

        .quiz-explanation.has-content {
            border-color: var(--soft-orange);
            background: #ffe4cc;
        }

        .back-button {
            background: #f8f4f0;
            border: 2px solid var(--light-brown);
            color: var(--primary-brown);
            border-radius: 15px;
            padding: 0.5rem 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .back-button:hover {
            background: #fff8f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        .mode-btn {
            background: var(--white);
            border: 3px solid var(--light-brown);
            border-radius: 12px;
            color: var(--primary-brown);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .mode-btn:hover {
            border-color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
            background: #fff8f0;
        }

        .mode-btn.active {
            background: #ffe4cc;
            border-color: var(--soft-orange);
            color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        .stats-display {
            background: #fff8f0;
            border: 2px solid var(--light-brown);
            border-radius: 20px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .floating-button {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 56px;
            height: 56px;
            background: var(--light-brown);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px var(--shadow);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1002;
            cursor: pointer;
        }

        .floating-button.hidden {
            display: none !important;
        }

        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px var(--shadow);
            background: var(--soft-orange);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            color: var(--primary-brown);
            padding: 12px 16px;
            border-radius: 20px;
            border: 2px solid var(--light-brown);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            box-shadow: 0 6px 20px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .notification.show {
            transform: translateX(0);
        }

        .subject-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .category-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .section-divider {
            height: 2px;
            background: var(--light-brown);
            margin: 1rem 0;
            border-radius: 1px;
        }

        .grade-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--light-brown);
            text-align: center;
            margin: 0.75rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– */
        .score-pulse {
            animation: score-pulse 0.6s ease-in-out;
        }

        @keyframes score-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(1.3); }
        }

        /* ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .tap-effect {
            position: relative;
            overflow: visible;
        }

        .tap-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
        }

        .tap-effect.tapped::after {
            animation: tap-ripple 0.6s ease-out;
        }

        @keyframes tap-ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 0.8;
            }
            100% {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 640px) {
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }

            .floating-button {
                bottom: 20px;
                left: 20px;
                width: 52px;
                height: 52px;
                font-size: 20px;
            }

            .clean-card {
                margin: 0.5rem;
                padding: 1rem;
            }

            .clean-card:last-of-type {
                margin-bottom: 4rem;
            }

            body {
                padding-bottom: 5rem;
            }

            .game-title {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }

            .subject-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .category-grid {
                grid-template-columns: 1fr;
                gap: 0.4rem;
            }

            .subject-btn, .category-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }

            .quiz-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            #quizQ {
                font-size: 0.9rem;
                line-height: 1.3;
            }

            .quiz-explanation {
                height: 120px;
                padding: 0.5rem;
                font-size: 0.9rem;
                line-height: 1.3;
            }
        }

        /* ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒ—æ”¹å–„ */
        button, .subject-btn, .category-btn, .quiz-option, .clean-button, .back-button, .mode-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        * {
            touch-action: manipulation;
        }

        input, select, textarea {
            font-size: 16px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <div id="mainSubjectModal" class="modal show">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h1 class="game-title" id="gameTitle">
                    <span class="cat-icon" id="leftCat">ğŸ±</span>NEKOPON Quiz<span class="cat-icon" id="rightCat">ğŸ±</span>
                </h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“š æ•™ç§‘ã‚’é¸ã¶ã«ã‚ƒã€œâ™ª
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã—ãŸã„æ•™ç§‘ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect" data-subject="social">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">ç¤¾ä¼š</div>
                </button>
                <button class="subject-btn tap-effect" data-subject="science">
                    <div class="subject-icon text-2xl mb-1">ğŸ”¬</div>
                    <div class="subject-name font-semibold text-sm">ç†ç§‘</div>
                </button>
                <button class="subject-btn tap-effect" data-subject="english">
                    <div class="subject-icon text-2xl mb-1">ğŸ“–</div>
                    <div class="subject-name font-semibold text-sm">è‹±èª</div>
                </button>
            </div>
        </div>
    </div>

    <div id="socialModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ ç¤¾ä¼š
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect" data-category="geography">
                    <div class="subject-icon text-2xl mb-1">ğŸ—ºï¸</div>
                    <div class="subject-name font-semibold text-sm">åœ°ç†</div>
                </button>
                <button class="subject-btn tap-effect" data-category="history">
                    <div class="subject-icon text-2xl mb-1">ğŸ›ï¸</div>
                    <div class="subject-name font-semibold text-sm">æ­´å²</div>
                </button>
                <button class="subject-btn tap-effect" data-category="civics">
                    <div class="subject-icon text-2xl mb-1">âš–ï¸</div>
                    <div class="subject-name font-semibold text-sm">å…¬æ°‘</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <div id="scienceModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ”¬ ç†ç§‘
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect" data-category="chemistry">
                    <div class="subject-icon text-2xl mb-1">ğŸ§ª</div>
                    <div class="subject-name font-semibold text-sm">åŒ–å­¦</div>
                </button>
                <button class="subject-btn tap-effect" data-category="biology">
                    <div class="subject-icon text-2xl mb-1">ğŸ§¬</div>
                    <div class="subject-name font-semibold text-sm">ç”Ÿç‰©</div>
                </button>
                <button class="subject-btn tap-effect" data-category="physics">
                    <div class="subject-icon text-2xl mb-1">âš›ï¸</div>
                    <div class="subject-name font-semibold text-sm">ç‰©ç†</div>
                </button>
                <button class="subject-btn tap-effect" data-category="earth">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">åœ°å­¦</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <div id="englishModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“– è‹±èª
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect" data-category="english_words">
                    <div class="subject-icon text-2xl mb-1">ğŸ“</div>
                    <div class="subject-name font-semibold text-sm">è‹±å˜èª</div>
                </button>
                <button class="subject-btn tap-effect" data-category="english_phrases">
                    <div class="subject-icon text-2xl mb-1">ğŸ’¬</div>
                    <div class="subject-name font-semibold text-sm">è‹±ç†Ÿèª</div>
                </button>
                <button class="subject-btn tap-effect" data-category="english_grammar">
                    <div class="subject-icon text-2xl mb-1">ğŸ“˜</div>
                    <div class="subject-name font-semibold text-sm">èªå½¢å¤‰åŒ–</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ä»¥ä¸‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ã¯çœç•¥ï¼ˆåŒæ§˜ã®æ§‹é€ ã§å…¨ã¦ä½œæˆï¼‰ -->
    <div id="geographyModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ—ºï¸ åœ°ç†
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="geographyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startGeographyQuiz" class="clean-button px-6 py-2 text-sm tap-effect" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚åŒæ§˜ï¼ˆçœç•¥ï¼‰ -->

    <div id="gameScreen" class="hidden">
        <div class="clean-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title">
                <span class="cat-icon">ğŸ±</span>NEKOPON Quiz<span class="cat-icon">ğŸ±</span>
            </h1>
            <div id="currentCategory" class="text-lg font-semibold text-gray-700 mb-4"></div>
            <div class="stats-display">
                <div class="grid grid-cols-3 gap-4 text-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-gray-800" id="correctCount">0</div>
                        <div class="text-xs text-gray-600">æ­£è§£æ•°ã ã«ã‚ƒâ™ª</div>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-gray-800" id="wrongCount">0</div>
                        <div class="text-xs text-gray-600">ä¸æ­£è§£æ•°ã ã«ã‚ƒ</div>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-gray-800" id="totalCount">0</div>
                        <div class="text-xs text-gray-600">ç·å•é¡Œæ•°ã ã«ã‚ƒã€œ</div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">ğŸ“‹ å‡ºé¡Œå½¢å¼ã ã«ã‚ƒã€œ</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="randomModeBtn" class="mode-btn active tap-effect" data-mode="random">
                            ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚ƒ
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn tap-effect" data-mode="sequential">
                            ğŸ“‹ é †ç•ªé€šã‚Šã«ã‚ƒ
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mt-2" id="modeDescription">
                        å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª
                    </div>
                </div>
            </div>
            <button id="startQuizButton" class="clean-button px-6 py-3 text-base font-semibold mt-6 tap-effect">
                âœ¨ ã‚¹ã‚¿ãƒ¼ãƒˆã«ã‚ƒã€œâ™ª
            </button>
        </div>
    </div>

    <div id="quizModal" class="modal">
        <div class="clean-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-semibold text-lg text-gray-700">
                    âœ¨ NEKOPON Quiz âœ¨
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-base font-medium text-center text-gray-800 leading-relaxed"></p>
                <div id="quizOptions" class="space-y-2"></div>
                <div id="quizExplanation" class="quiz-explanation">
                    <p id="quizMsg" class="font-semibold text-center text-base"></p>
                </div>
                <div class="flex gap-2">
                    <button id="quizNext" class="flex-1 clean-button py-2 text-sm tap-effect">
                        ğŸŒŸ æ¬¡ã®å•é¡Œã«ã‚ƒã€œ
                    </button>
                    <button id="quizBack" class="flex-1 back-button py-2 text-sm tap-effect">
                        ğŸ  æˆ»ã‚‹ã«ã‚ƒã€œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <button id="changeSubject" class="floating-button hidden tap-effect">
        ğŸ“š
    </button>

    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-xl">âœ¨</span>
            <div>
                <div class="font-semibold text-sm">NEKOPON Quiz</div>
                <div id="notificationText" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- NEKOPONåŠ¹æœéŸ³ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        class NekoponSoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã«ã‚ƒã€œ');
                }
            }

            playClick() {
                this.createNekoTone(600, 0.2, 0.15, 'sine');
            }

            playCorrect() {
                // æ­£è§£æ™‚ã®å¯æ„›ã„ä¸Šæ˜‡éŸ³
                this.createNekoTone(523, 0.15, 0.2);
                setTimeout(() => this.createNekoTone(659, 0.15, 0.2), 100);
                setTimeout(() => this.createNekoTone(784, 0.25, 0.25), 200);
                setTimeout(() => this.createNekoTone(1047, 0.3, 0.2), 350);
            }

            playWrong() {
                // ä¸æ­£è§£æ™‚ã®å¯æ„›ã„ä¸‹é™éŸ³
                this.createNekoTone(400, 0.2, 0.15, 'sine');
                setTimeout(() => this.createNekoTone(300, 0.3, 0.2, 'sine'), 150);
            }

            playSuccess() {
                // æˆåŠŸæ™‚ã®ã‚­ãƒ©ã‚­ãƒ©éŸ³
                const notes = [523, 587, 659, 698, 784, 880, 988, 1047, 1175];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.createNekoTone(freq, 0.15, 0.2, 'sine'), i * 80);
                });
            }

            playTitle() {
                // ã‚¿ã‚¤ãƒˆãƒ«å°‚ç”¨ã®ç‰¹åˆ¥ãªéŸ³
                this.createNekoTone(900, 0.3, 0.2);
                setTimeout(() => this.createNekoTone(1200, 0.4, 0.15), 200);
                setTimeout(() => this.createNekoTone(800, 0.5, 0.1), 600);
            }

            playPurr() {
                // çŒ«ã®é³´ãå£°ã£ã½ã„éŸ³
                this.createNekoTone(300, 1.2, 0.1, 'sine');
            }

            playSpawn() {
                // ç”Ÿæˆæ™‚ã®ãƒãƒƒãƒ—éŸ³
                this.createNekoTone(800, 0.3, 0.15, 'sine');
            }

            playMerge() {
                // ãƒãƒ¼ã‚¸æ™‚ã®éŸ³
                this.createNekoTone(700, 0.4, 0.2);
                setTimeout(() => this.createNekoTone(900, 0.3, 0.15), 200);
            }

            playLevelup() {
                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éŸ³
                const notes = [523, 659, 784, 1047, 1319];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.createNekoTone(freq, 0.2, 0.3), i * 120);
                });
            }

            createNekoTone(frequency, duration, volume = 0.2, type = 'sine') {
                if (!this.audioContext) return;

                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();

                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;

                    // å¯æ„›ã‚‰ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
                    filterNode.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }

            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            }
        }

        const soundSystem = new NekoponSoundSystem();

        /* ----------------- çŒ«èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ----------------- */
        const nekoMessages = {
            correct: [
                'ã™ã”ã„ã«ã‚ƒã€œâ™ª', 'æ­£è§£ã ã«ã‚ƒï¼', 'ã‚„ã£ãŸã«ã‚ƒã€œï¼', 'å¤©æ‰ã«ã‚ƒâ™ª', 'ã‹ã—ã“ã„ã«ã‚ƒã€œ',
                'ã°ã£ã¡ã‚Šã«ã‚ƒï¼', 'ã™ã°ã‚‰ã—ã„ã«ã‚ƒâ™ª', 'ã•ã™ãŒã«ã‚ƒã€œ', 'ãˆã‚‰ã„ã«ã‚ƒï¼', 'ã±ãƒ¼ãµã‡ãã¨ã«ã‚ƒâ™ª'
            ],
            wrong: [
                'ã–ã‚“ã­ã‚“ã«ã‚ƒã€œ', 'ãŠã—ã„ã«ã‚ƒï¼', 'ã¤ããŒã‚“ã°ã‚‹ã«ã‚ƒã€œ', 'ã©ã‚“ã¾ã„ã«ã‚ƒâ™ª', 'ãŠã—ã‹ã£ãŸã«ã‚ƒã€œ',
                'ã‚‚ã†å°‘ã—ã«ã‚ƒï¼', 'ãƒ•ã‚¡ã‚¤ãƒˆã«ã‚ƒã€œâ™ª', 'ã¤ãã¯ã§ãã‚‹ã«ã‚ƒï¼', 'ãŒã‚“ã°ã‚‹ã«ã‚ƒã€œ', 'ã‚ãã‚‰ã‚ãªã„ã«ã‚ƒâ™ª'
            ],
            tap: [
                'ã«ã‚ƒã€œã‚“â™ª', 'ã½ã‚“ã½ã‚“â™ª', 'ãã‚ƒã‚ã„ã„ã€œ', 'ã‚‚ãµã‚‚ãµâ™ª', 'ãµã‚ãµã‚ã€œ',
                'ãºã‚ãºã‚â™ª', 'ã½ã‚ˆã½ã‚ˆã€œ', 'ãã‚‰ãã‚‰â™ª', 'ã´ã‹ã´ã‹ã€œ', 'ã‚ãã‚ãâ™ª'
            ],
            notification: [
                'ãŠçŸ¥ã‚‰ã›ã«ã‚ƒã€œâ™ª', 'ã ã„ã˜ãªã“ã¨ã«ã‚ƒï¼', 'ãã„ã¦ã»ã—ã„ã«ã‚ƒã€œ', 'ãƒã‚§ãƒƒã‚¯ã«ã‚ƒâ™ª', 'ã¿ã¦ã«ã‚ƒã€œ'
            ],
            start: [
                'ã¯ã˜ã¾ã‚‹ã«ã‚ƒã€œâ™ª', 'ãŒã‚“ã°ã‚‹ã«ã‚ƒï¼', 'ã‚ˆã‚ã—ãã«ã‚ƒã€œ', 'ãŸã®ã—ã‚‚ã†ã«ã‚ƒâ™ª', 'ã™ãŸãƒ¼ã¨ã«ã‚ƒã€œï¼'
            ]
        };

        /* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ----------------- */
        function createNekoParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.fontSize = '24px';
            document.body.appendChild(particle);

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2000);
        }

        function createNekoParticles(x, y, emojis, count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const offsetX = (Math.random() - 0.5) * 60;
                    const offsetY = (Math.random() - 0.5) * 60;
                    createNekoParticle(emoji, '#d2691e', x + offsetX, y + offsetY);
                }, i * 50);
            }
        }

        function showNekoMsg(text, x, y) {
            const el = document.createElement('div');
            el.className = 'floating-msg';
            el.textContent = text;
            el.style.left = Math.min(x, window.innerWidth - 100) + 'px';
            el.style.top = Math.min(y, window.innerHeight - 40) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            // çŒ«èªã«å¤‰æ›
            const nekoText = text + 'ã«ã‚ƒã€œâ™ª';
            notificationText.textContent = nekoText;
            notification.classList.add('show');
            
            // é€šçŸ¥éŸ³
            soundSystem.playSpawn();
            soundSystem.vibrate([50, 30, 50]);
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function addTapEffect(element) {
            element.addEventListener('click', function(e) {
                // ãƒªãƒƒãƒ—ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                this.classList.add('tapped');
                setTimeout(() => this.classList.remove('tapped'), 600);
                
                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
                const rect = this.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                createNekoParticles(centerX, centerY, ['âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ’–'], 3);
                
                // çŒ«èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const message = nekoMessages.tap[Math.floor(Math.random() * nekoMessages.tap.length)];
                showNekoMsg(message, centerX, centerY);
                
                // åŠ¹æœéŸ³ã¨ãƒã‚¤ãƒ–
                soundSystem.playClick();
                soundSystem.vibrate([30]);
            });
        }

        /* ----------------- ã‚¿ã‚¤ãƒˆãƒ«çŒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ----------------- */
        function bounceCat(side) {
            const catId = side === 'left' ? 'leftCat' : 'rightCat';
            const catElement = document.getElementById(catId);

            catElement.classList.add('bounce');
            soundSystem.playPurr();
            soundSystem.vibrate([50]);

            const rect = catElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, ['ğŸ’«', 'âœ¨', 'ğŸŒŸ'], 3);

            const message = 'ã«ã‚ƒã€œã‚“â™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                catElement.classList.remove('bounce');
            }, 800);
        }

        function bounceTitle() {
            const titleElement = document.getElementById('gameTitle');
            titleElement.classList.add('title-bounce');

            soundSystem.playTitle();
            soundSystem.vibrate([120, 60, 120, 60, 180]);

            const rect = titleElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, 
                              ['ğŸ’«', 'âœ¨', 'ğŸŒŸ', 'ğŸ’–', 'ğŸŠ', 'ğŸ†', 'ğŸŒˆ'], 8);

            const message = 'NEKOPON Quiz ã ã«ã‚ƒã€œâ™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                titleElement.classList.remove('title-bounce');
            }, 1200);
        }

        /* ----------------- å…ƒã®ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåŠ¹æœéŸ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çŒ«ä»•æ§˜ã«å¤‰æ›´ï¼‰ ----------------- */
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalCount = 0;
        let usedQuestions = [];
        let currentSubject = '';
        let questionMode = 'random';
        let sequentialIndex = 0;

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾©ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
        const categories = {
            geography: [
                {id: 'geo_world_overview', name: '1.ä¸–ç•Œã®å§¿'},
                {id: 'geo_japan_overview', name: '2.æ—¥æœ¬ã®å§¿'},
                // ... çœç•¥ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
            ],
            // ... ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚‚åŒæ§˜
        };

        /* ----------------- è‹±èªç™ºéŸ³ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        function speakWord(wordToSpeak) {
            if (!('speechSynthesis' in window) || !wordToSpeak) return;
            
            const utterance = new SpeechSynthesisUtterance(wordToSpeak);
            const voices = speechSynthesis.getVoices();
            let preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang) && (v.name.includes('Google') || v.localService || v.default));
            if (!preferredVoice) preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang));
           
            utterance.voice = preferredVoice || voices.find(v => v.lang && v.lang.startsWith('en-')); 
            utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
            utterance.rate = 0.9; 
            utterance.pitch = 1;
            speechSynthesis.cancel(); 
            speechSynthesis.speak(utterance);
        }

        function isEnglishCategory() {
            return selectedCategories.some(categoryId => 
                categoryId.startsWith('words_') || categoryId.startsWith('phrases_') || categoryId.startsWith('grammar_')
            );
        }

        /* ----------------- ç”»é¢é·ç§»é–¢æ•° ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainSubjectModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToSocial() {
            hideAllModals();
            document.getElementById('socialModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToScience() {
            hideAllModals();
            document.getElementById('scienceModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToEnglish() {
            hideAllModals();
            document.getElementById('englishModal').classList.add('show');
            soundSystem.playClick();
        }

        /* ----------------- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆçŒ«ä»•æ§˜ã«å¤‰æ›´ï¼‰ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('å˜å…ƒã‚’é¸æŠã—ã¦ã»ã—ã„ã«ã‚ƒã€œ');
                return;
            }

            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) {
                showNotification('å•é¡ŒãŒã¾ã æº–å‚™ä¸­ã ã«ã‚ƒã€œ');
                return;
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('å…¨å•ã‚¯ãƒªã‚¢ã ã«ã‚ƒã€œâ™ª ãƒªã‚»ãƒƒãƒˆã—ãŸã«ã‚ƒï¼');
            }

            // å•é¡Œé¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('å…¨å•é¡Œã‚’ä¸€å‘¨ã—ãŸã«ã‚ƒã€œâ™ª æœ€åˆã‹ã‚‰å†é–‹ã«ã‚ƒï¼');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•ã ã«ã‚ƒã€œ)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            // è‹±èªã®å•é¡Œãªã‚‰éŸ³å£°ã§ç™ºéŸ³
            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            // åˆæœŸçŠ¶æ…‹ï¼šãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full tap-effect';
                
                // ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                addTapEffect(btn);
                
                btn.onclick = () => {
                    // è‹±èªã®é¸æŠè‚¢ãªã‚‰éŸ³å£°ã§ç™ºéŸ³
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    // æœ€åˆã®å›ç­”ã®ã¿çµ±è¨ˆã‚’æ›´æ–°
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        if (i === quiz.ans) {
                            correctCount++;
                            soundSystem.playCorrect();
                            soundSystem.vibrate([100, 50, 100, 50, 150]);
                            
                            const correctMsg = nekoMessages.correct[Math.floor(Math.random() * nekoMessages.correct.length)];
                            showNotification(correctMsg);
                            
                            const rect = btn.getBoundingClientRect();
                            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, 
                                              ['âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰', 'ğŸŠ'], 5);
                        } else {
                            wrongCount++;
                            soundSystem.playWrong();
                            soundSystem.vibrate([80, 40, 80]);
                            
                            const wrongMsg = nekoMessages.wrong[Math.floor(Math.random() * nekoMessages.wrong.length)];
                            showNotification(wrongMsg);
                        }
                        updateStats();
                        
                        // æœ€åˆã®å›ç­”å¾Œï¼šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    // æ¯å›ã®é¸æŠè‚¢ã«å¯¾ã™ã‚‹è§£èª¬è¡¨ç¤º
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `ğŸ‰ æ­£è§£ã ã«ã‚ƒã€œâ™ª ${quiz.exp || ''}`;
                        msgEl.style.color = 'var(--light-brown)';
                    } else {
                        msgEl.innerHTML = `âŒ æ®‹å¿µã«ã‚ƒã€œ...æ­£è§£ã¯ã€Œ${quiz.opts[quiz.ans]}ã€ã ã«ã‚ƒâ™ª ${quiz.exp || ''}`;
                        msgEl.style.color = '#cd5c5c';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });

            // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã®å‡¦ç†
            nextBtn.onclick = () => {
                soundSystem.playSuccess();
                loadNextQuiz();
            };

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
            backBtn.onclick = () => {
                soundSystem.playClick();
                modal.classList.remove('show');
                showNotification('ãŠç–²ã‚Œæ§˜ã ã£ãŸã«ã‚ƒã€œâ™ª');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            // æ¬¡ã®å•é¡Œèª­ã¿è¾¼ã¿ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒã˜ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã¿çŒ«ä»•æ§˜ï¼‰
            openQuiz(); // æ–°ã—ã„å•é¡Œã‚’è¡¨ç¤º
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = totalCount;
            
            // ã‚¹ã‚³ã‚¢æ›´æ–°æ™‚ã®ãƒ‘ãƒ«ã‚¹åŠ¹æœ
            document.querySelector('.stats-display').classList.add('score-pulse');
            setTimeout(() => {
                document.querySelector('.stats-display').classList.remove('score-pulse');
            }, 600);
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª';
                usedQuestions = [];
                showNotification('ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆãŸã«ã‚ƒã€œ');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª';
                sequentialIndex = 0;
                showNotification('é †ç•ªé€šã‚Šå‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆãŸã«ã‚ƒã€œ');
            }
        }

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ----------------- */
        function toggleCategorySelection(subject, categoryId, buttonElement) {
            soundSystem.playClick();
            if (selectedCategories.includes(categoryId)) {
                selectedCategories = selectedCategories.filter(id => id !== categoryId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(categoryId);
                buttonElement.classList.add('active');
            }

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const camelCase = subject.split('_')
                .map((word, index) => index === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
            const startButton = document.getElementById(`start${camelCase}Quiz`);

            if (startButton) {
                startButton.disabled = selectedCategories.length === 0;
            }
        }

        function startSelectedQuiz(subject, subjectName) {
            currentSubject = subject;
            hideAllModals();
            document.getElementById('currentCategory').textContent = `${subjectName} - ${selectedCategories.length}å˜å…ƒé¸æŠä¸­ã ã«ã‚ƒã€œâ™ª`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            correctCount = 0;
            wrongCount = 0;
            totalCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            updateStats();
            showNotification(`${subjectName}ã®${selectedCategories.length}å˜å…ƒã‚’é¸æŠã—ãŸã«ã‚ƒã€œâ™ª`);
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆæœŸåŒ–ã¨å…¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆçœç•¥...å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨ã»ã¼åŒã˜æ§‹é€ ï¼‰
        function initCategorySelection() {
            // åœ°ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const geographyContainer = document.getElementById('geographyCategories');
            categories.geography.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('geography', category.id, btn);
                addTapEffect(btn);
                geographyContainer.appendChild(btn);
            });
            
            // ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚‚åŒæ§˜ã«å‡¦ç†...
        }

        function initEventListeners() {
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('gameTitle').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceTitle();
            });

            // ã‚¿ã‚¤ãƒˆãƒ«çŒ«ã®ã‚¿ãƒƒãƒ—
            document.getElementById('leftCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceCat('left');
            });

            document.getElementById('rightCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceCat('right');
            });

            // å…¨ãƒœã‚¿ãƒ³ã«ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
            document.querySelectorAll('.tap-effect').forEach(addTapEffect);

            // ãƒ¡ã‚¤ãƒ³æ•™ç§‘é¸æŠ
            document.querySelectorAll('[data-subject]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    soundSystem.playSuccess();
                    const subject = e.currentTarget.dataset.subject;
                    hideAllModals();
                    document.getElementById(subject + 'Modal').classList.add('show');
                });
            });

            // å‡ºé¡Œå½¢å¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('startQuizButton').addEventListener('click', () => {
                soundSystem.playLevelup();
                const startMsg = nekoMessages.start[Math.floor(Math.random() * nekoMessages.start.length)];
                showNotification(startMsg);
                openQuiz();
            });

            // æ•™ç§‘å¤‰æ›´ãƒœã‚¿ãƒ³
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                soundSystem.playClick();
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
                showNotification('æ•™ç§‘é¸æŠã«æˆ»ã£ãŸã«ã‚ƒã€œâ™ª');
            });

            // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼...ï¼ˆçœç•¥ï¼‰
        }

        /* ----------------- åˆæœŸåŒ– ----------------- */
        document.addEventListener('DOMContentLoaded', () => {
            initCategorySelection();
            initEventListeners();
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
            document.getElementById('changeSubject').classList.add('hidden');
            
            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });

            // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
            if ('speechSynthesis' in window && typeof speechSynthesis.getVoices === 'function') {
                const voicePolling = setInterval(() => {
                    if (speechSynthesis.getVoices().length) {
                        clearInterval(voicePolling);
                    } else {
                        speechSynthesis.getVoices(); 
                    }
                }, 200);
            }

            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            setTimeout(() => {
                showNotification('NEKOPON Quizã¸ã‚ˆã†ã“ãã«ã‚ƒã€œâ™ª');
            }, 1000);
        });
    </script>
</body>
</html>